<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Firebase Compatibility -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6', 100: '#CCFFCC', 500: '#00B300',
                            600: '#009900', 700: '#008000', 800: '#006600', 900: '#004C00',
                        },
                        'teal': { 600: '#008080' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #008000;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        .loader-lg { width: 48px; height: 48px; border-width: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const BRANCHES = ['Guadalupe', 'Mabolo', 'Talisay', 'Bacayan', 'Lapu-lapu', 'AS Fortuna'];
        const SERVICE_CATEGORIES = ['Specialized Massage', 'Relax & Revive', 'Premium Massage', 'Add-ons', 'Others'];
        
        // --- FIREBASE CONFIGURATION ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        
        const firebaseConfig = MANUAL_FIREBASE_CONFIG;
        const currentAppId = firebaseConfig.projectId;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons({ root: wrapperRef.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className, ...props } });
                }
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="layout-dashboard" {...p} />,
            Plus: (p) => <Icon name="plus" {...p} />,
            DollarSign: (p) => <Icon name="dollar-sign" {...p} />,
            Calendar: (p) => <Icon name="calendar" {...p} />,
            CheckCircle2: (p) => <Icon name="check-circle-2" {...p} />,
            Clock: (p) => <Icon name="clock" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />,
            Users: (p) => <Icon name="users" {...p} />,
            Sparkles: (p) => <Icon name="sparkles" {...p} />,
            Home: (p) => <Icon name="home" {...p} />,
            Building2: (p) => <Icon name="building-2" {...p} />,
            Car: (p) => <Icon name="car" {...p} />,
            UserCircle2: (p) => <Icon name="user-circle-2" {...p} />,
            History: (p) => <Icon name="history" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            ChevronUp: (p) => <Icon name="chevron-up" {...p} />,
            Archive: (p) => <Icon name="archive" {...p} />,
            AlertTriangle: (p) => <Icon name="alert-triangle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            LogOut: (p) => <Icon name="log-out" {...p} />,
            Lock: (p) => <Icon name="lock" {...p} />,
            ShieldCheck: (p) => <Icon name="shield-check" {...p} />,
            UserPlus: (p) => <Icon name="user-plus" {...p} />,
            User: (p) => <Icon name="user" {...p} />,
            Fingerprint: (p) => <Icon name="fingerprint" {...p} />,
            UserCog: (p) => <Icon name="user-cog" {...p} />,
            Cloud: (p) => <Icon name="cloud" {...p} />,
            WifiOff: (p) => <Icon name="wifi-off" {...p} />,
            Trophy: (p) => <Icon name="trophy" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />,
            Tag: (p) => <Icon name="tag" {...p} />,
            Hourglass: (p) => <Icon name="hourglass" {...p} />,
            Pencil: (p) => <Icon name="pencil" {...p} />,
            Loader2: (p) => <Icon name="loader-2" {...p} />,
            ClipboardList: (p) => <Icon name="clipboard-list" {...p} />,
            MinusCircle: (p) => <Icon name="minus-circle" {...p} />,
            Wallet: (p) => <Icon name="wallet" {...p} />,
            TrendingUp: (p) => <Icon name="trending-up" {...p} />,
            SteeringWheel: (p) => <Icon name="joystick" {...p} />, 
            DoorOpen: (p) => <Icon name="door-open" {...p} />, 
            CreditCard: (p) => <Icon name="credit-card" {...p} />, 
            Smartphone: (p) => <Icon name="smartphone" {...p} />, 
            Banknote: (p) => <Icon name="banknote" {...p} />, 
            Landmark: (p) => <Icon name="landmark" {...p} /> 
        };

        // --- HELPERS ---
        const hashPin = async (pin) => {
            if (!pin || pin.length < 4) return null;
            try {
                const msgUint8 = new TextEncoder().encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) { return null; }
        };

        const getMillis = (ts) => {
            if (!ts) return Date.now();
            if (typeof ts === 'number') return ts;
            if (typeof ts.toMillis === 'function') return ts.toMillis();
            if (ts.seconds) return ts.seconds * 1000;
            return 0;
        };

        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 min-w-[200px]">
                    <div className="loader loader-lg"></div>
                    <p className="text-slate-600 font-semibold text-sm animate-pulse">{message || 'Processing...'}</p>
                </div>
            </div>
        );

        // --- List Management Component ---
        const ListManagement = ({ therapists, services, durations, drivers, rooms, onAdd, onDelete, onEdit }) => {
            const [activeTab, setActiveTab] = useState('therapist');  
            
            const [newItemName, setNewItemName] = useState('');
            const [newItemCategory, setNewItemCategory] = useState(SERVICE_CATEGORIES[0]); 
            const [newItemPrices, setNewItemPrices] = useState({});  
            const [newItemCommission, setNewItemCommission] = useState('');  
            
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editCategory, setEditCategory] = useState(SERVICE_CATEGORIES[0]);
            const [editPrices, setEditPrices] = useState({});
            const [editCommission, setEditCommission] = useState('');  

            const [modal, setModal] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red' });
            const closeModal = () => setModal({ ...modal, isOpen: false });
            
            const isServiceAddDisabled = activeTab === 'service' && durations.length === 0;

            const handleFormSubmit = (e) => {
                e.preventDefault();
                let extraData = null;
                if (activeTab === 'service') {
                    if (durations.length === 0) return; 
                    extraData = { prices: newItemPrices, category: newItemCategory };
                } else if (activeTab === 'therapist') {
                    extraData = { commissionRate: parseFloat(newItemCommission) || 0 };
                }

                onAdd(activeTab, newItemName, extraData);
                setNewItemName('');
                setNewItemPrices({});
                setNewItemCommission('');  
            };
            
            const startEdit = (item) => {
                setEditingId(item.id);
                setEditName(item.name);
                setEditPrices(item.prices || {});
                setEditCommission(item.commissionRate !== undefined ? String(item.commissionRate) : ''); 
                setEditCategory(item.category || SERVICE_CATEGORIES[0]); 
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditName('');
                setEditPrices({});
                setEditCommission('');
            };

            const saveEdit = () => {
                const updatedData = { name: editName.trim() };
                if (activeTab === 'service') {
                    updatedData.prices = editPrices;
                    updatedData.category = editCategory; 
                } else if (activeTab === 'therapist') {  
                    updatedData.commissionRate = parseFloat(editCommission) || 0;
                }
                onEdit(activeTab, editingId, updatedData);
                setEditingId(null);
            };

            const handlePriceChange = (durationName, val, isEdit = false) => {
                const setter = isEdit ? setEditPrices : setNewItemPrices;
                const current = isEdit ? editPrices : newItemPrices;
                if (!val) {
                    const copy = { ...current };
                    delete copy[durationName];
                    setter(copy);
                } else {
                    setter({ ...current, [durationName]: parseFloat(val) });
                }
            };

            let currentList = [];
            let placeholderText = "";
            let icon = null;

            if (activeTab === 'therapist') { currentList = therapists; placeholderText = "Enter Therapist Name"; icon = <Icons.Users size={18} />; } 
            else if (activeTab === 'service') { currentList = services; placeholderText = "Enter Service Name"; icon = <Icons.Tag size={18} />; } 
            else if (activeTab === 'duration') { currentList = durations; placeholderText = "Enter Duration (e.g. 60 Mins)"; icon = <Icons.Hourglass size={18} />; } 
            else if (activeTab === 'driver') { currentList = drivers; placeholderText = "Enter Driver Name"; icon = <Icons.Car size={18} />; } 
            else if (activeTab === 'room') { currentList = rooms; placeholderText = "Enter Room Name/Number"; icon = <Icons.DoorOpen size={18} />; }

            return (
                <div className="space-y-6 fade-in">
                    <h2 className="text-lg font-bold text-logo-green-800 flex gap-2 items-center"><Icons.ShieldCheck size={18} className="text-logo-green-700"/> Master Data Lists</h2>
                    
                    <div className="flex bg-slate-100 p-1 rounded-lg overflow-x-auto">
                        {['therapist','room','driver','duration','service'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-2 px-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 min-w-[80px] capitalize ${activeTab===tab ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                                {tab}
                            </button>
                        ))}
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6">
                        <h3 className="font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide text-slate-500"><Icons.Plus size={16}/> Add New {activeTab}</h3>
                        <form onSubmit={handleFormSubmit} className="flex flex-col gap-3">
                            <div className="flex gap-2">
                                <input required placeholder={placeholderText} value={newItemName} onChange={e => setNewItemName(e.target.value)} className="flex-1 p-3 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-logo-green-500 outline-none"/>
                            </div>
                            
                            {activeTab === 'service' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <div className="mb-3">
                                        <label className="text-xs font-bold text-slate-500 mb-1 block uppercase">Category</label>
                                        <select value={newItemCategory} onChange={e => setNewItemCategory(e.target.value)} className="w-full p-2 border rounded-lg text-sm bg-white outline-none">
                                            {SERVICE_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                        </select>
                                    </div>
                                    <p className="text-xs font-bold text-slate-500 mb-2 uppercase">Set Prices per Duration (Optional)</p>
                                    {durations.length === 0 && <p className="text-xs text-red-400 italic">Add items to "Minutes" tab first to set prices.</p>}
                                    <div className="grid grid-cols-2 gap-2">
                                        {durations.map(d => (
                                            <div key={d.id} className="flex items-center gap-2 bg-white p-2 border rounded">
                                                <span className="text-xs font-bold text-slate-600 whitespace-nowrap w-16">{d.name}:</span>
                                                <input type="number" placeholder="Price" className="w-full text-sm outline-none" value={newItemPrices[d.name] || ''} onChange={e => handlePriceChange(d.name, e.target.value, false)}/>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'therapist' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <label className="text-xs font-bold text-slate-500 mb-2 uppercase block">Commission Rate (%)</label>
                                    <input type="number" min="0" max="100" step="0.1" placeholder="e.g., 30 for 30%" className="w-full p-2 border rounded-lg text-sm outline-none" value={newItemCommission} onChange={e => setNewItemCommission(e.target.value)}/>
                                </div>
                            )}

                            <button type="submit" disabled={isServiceAddDisabled} className={`w-full text-white p-3 rounded-lg font-bold transition shadow-sm ${isServiceAddDisabled ? 'bg-slate-400 cursor-not-allowed' : 'bg-logo-green-600 hover:bg-logo-green-700'}`}>Add to List</button>
                        </form>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="p-4 bg-logo-green-50 font-bold text-logo-green-800 text-sm border-b border-logo-green-100 flex justify-between items-center">
                            <span>Current {activeTab}s ({currentList.length})</span>
                            {icon}
                        </div>
                        <div className="max-h-[400px] overflow-y-auto">
                            {currentList.length === 0 ? <p className="text-center text-slate-400 p-6 italic">No items found.</p> : 
                                currentList.map(item => (
                                    <div key={item.id} className="p-4 border-b flex flex-col gap-2 last:border-b-0 hover:bg-slate-50">
                                            <div className="flex justify-between items-center w-full">
                                                {editingId === item.id ? (
                                                    <div className="flex-1 mr-2 flex flex-col gap-2">
                                                        <input value={editName} onChange={e => setEditName(e.target.value)} className="p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-logo-green-500"/>
                                                        {activeTab === 'service' && (
                                                            <select value={editCategory} onChange={e => setEditCategory(e.target.value)} className="p-2 border rounded text-sm bg-white">
                                                                {SERVICE_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                                            </select>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-col">
                                                        <span className="text-slate-700 font-medium">{item.name}</span>
                                                        {activeTab === 'service' && item.category && <span className="text-[10px] text-slate-400 uppercase">{item.category}</span>}
                                                    </div>
                                                )}
                                                
                                                <div className="flex gap-1">
                                                    {editingId === item.id ? (
                                                        <>
                                                            <button onClick={saveEdit} className="text-logo-green-600 hover:bg-logo-green-50 p-2 rounded transition"><Icons.CheckCircle2 size={18}/></button>
                                                            <button onClick={cancelEdit} className="text-slate-400 hover:bg-slate-100 p-2 rounded transition"><Icons.X size={18}/></button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <button onClick={() => startEdit(item)} className="text-slate-300 hover:text-blue-500 p-2 rounded hover:bg-blue-50 transition" title="Edit Item"><Icons.Pencil size={16} /></button>
                                                            <button type="button" onClick={() => onDelete(activeTab, item.id, item.name)} className="text-slate-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition" title="Delete Item"><Icons.Trash2 size={16}/></button>
                                                        </>
                                                    )}
                                                </div>
                                            </div>

                                            {activeTab === 'service' && (
                                                <div className="text-xs text-slate-500 w-full">
                                                    {editingId === item.id ? (
                                                        <div className="grid grid-cols-2 gap-2 mt-2 bg-slate-100 p-2 rounded">
                                                            {durations.map(d => (
                                                                <div key={d.id} className="flex items-center gap-2">
                                                                    <span className="font-bold w-14">{d.name}:</span>
                                                                    <input type="number" className="w-full p-1 border rounded text-xs" placeholder="0" value={editPrices[d.name] || ''} onChange={e => handlePriceChange(d.name, e.target.value, true)}/>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="flex flex-wrap gap-2 mt-1">
                                                            {item.prices && Object.keys(item.prices).length > 0 ? Object.entries(item.prices).map(([dur, price]) => (
                                                                <span key={dur} className="bg-logo-green-50 text-logo-green-700 px-2 py-0.5 rounded border border-logo-green-100">{dur}: <span className="font-bold">P{price}</span></span>
                                                            )) : <span className="italic text-slate-300">No specific prices set</span>}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {activeTab === 'therapist' && (
                                                <div className="text-xs text-slate-500 w-full">
                                                    {editingId === item.id ? (
                                                        <div className="mt-2 bg-slate-100 p-2 rounded flex items-center gap-2">
                                                            <span className="font-bold w-20">Rate (%):</span>
                                                            <input type="number" min="0" max="100" step="0.1" className="w-full p-1 border rounded text-xs" placeholder="0" value={editCommission} onChange={e => setEditCommission(e.target.value)}/>
                                                        </div>
                                                    ) : (
                                                        <div className="flex flex-wrap gap-2 mt-1"><span className="bg-teal-50 text-teal-700 px-2 py-0.5 rounded border border-teal-100 font-bold">Commission: {item.commissionRate !== undefined ? `${item.commissionRate}%` : 'N/A'}</span></div>
                                                    )}
                                                </div>
                                            )}
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                      {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                </div>
            );
        };

        const AdminResetUserModal = ({ editUserModal, setEditUserModal, handleResetPin, userRole }) => {
            if (!editUserModal.isOpen || !editUserModal.user) return null;
            const targetUser = editUserModal.user;
            const requiredLen = targetUser.role === 'admin' ? 6 : 4;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 fade-in">
                    <div className="bg-white rounded-xl p-6 w-full max-w-sm">
                        <h3 className="text-xl font-bold text-logo-green-800 mb-4 flex items-center gap-2"><Icons.UserCog size={24}/> Reset Staff Credentials</h3>
                        <div className="bg-slate-50 p-4 rounded-lg mb-4">
                            <p className="text-xs text-slate-500 uppercase font-bold">Staff Name:</p><p className="font-bold text-slate-800 text-lg mb-2">{targetUser.name}</p>
                            <p className="text-xs text-slate-500 uppercase font-bold">Username:</p><p className="font-mono text-logo-green-700 text-sm">@{targetUser.username}</p>
                        </div>
                        <form onSubmit={handleResetPin} className="space-y-4">
                            <label className="block"><span className="text-sm font-semibold text-slate-700 block mb-1">Set New PIN ({requiredLen} Digits)</span><input required type="password" inputMode="numeric" maxLength={requiredLen} value={editUserModal.newPin} onChange={(e) => setEditUserModal({ ...editUserModal, newPin: e.target.value })} placeholder={`Enter new ${requiredLen}-digit PIN`} className="w-full p-3 border rounded-lg font-mono focus:ring-2 focus:ring-logo-green-500"/></label>
                            <div className="flex justify-end gap-2 pt-2"><button type="button" onClick={() => setEditUserModal({ isOpen: false, user: null, newPin: '' })} className="px-4 py-2 text-slate-500 rounded hover:bg-slate-100">Cancel</button><button type="submit" className="px-4 py-2 rounded text-white bg-logo-green-600 hover:bg-logo-green-700 font-bold">Reset PIN</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [fb, setFb] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbReady, setDbReady] = useState(false);
            const [configError, setConfigError] = useState(null);  
            const [isGlobalLoading, setIsGlobalLoading] = useState(false); 

            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [history, setHistory] = useState([]);
            const [dashboardDate, setDashboardDate] = useState(getTodayStr());
            const [offlineQueue, setOfflineQueue] = useState([]);
            const [isTransactionListenerActive, setIsTransactionListenerActive] = useState(true);

            // Master Lists
            const [therapistsList, setTherapistsList] = useState([]);
            const [servicesList, setServicesList] = useState([]);
            const [durationsList, setDurationsList] = useState([]);
            const [driversList, setDriversList] = useState([]); 
            const [roomsList, setRoomsList] = useState([]); 
            
            const [view, setView] = useState('dashboard');
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            const [showMyShift, setShowMyShift] = useState(false);
            const [historyStartDate, setHistoryStartDate] = useState('');
            const [historyEndDate, setHistoryEndDate] = useState('');
            
            // Forms
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPin, setLoginPin] = useState('');
            const [loginBranch, setLoginBranch] = useState('');  
            const [newUser, setNewUser] = useState({ name: '', username: '', pin: '', role: 'staff' });
            const [profileData, setProfileData] = useState({ username: '', pin: '' });
            
            const [formData, setFormData] = useState({
                clientName: '', clientContact: '', service: '', duration: '', therapist: '', amount: '',  
                type: 'booking', time: new Date().toTimeString().slice(0, 5), targetBranch: '', notes: '', category: '', 
                bookingDate: getTodayStr(), location: 'spa', transportFee: '', driver: '', room: '', paymentMethod: 'Cash'
            });
            const [modal, setModal] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red' });
            const [editUserModal, setEditUserModal] = useState({ isOpen: false, user: null, newPin: '' });
            const [selectedTherapists, setSelectedTherapists] = useState([]);
            const [selectedDrivers, setSelectedDrivers] = useState([]);
            const [therapistRows, setTherapistRows] = useState({});

            const closeModal = () => setModal({ ...modal, isOpen: false });
            
            // --- Activity Timer ---
            const activityTimerRef = useRef(null);
            const resetActivityTimer = () => {
                if (activityTimerRef.current) clearTimeout(activityTimerRef.current);
                activityTimerRef.current = setTimeout(() => {
                    if (isTransactionListenerActive) setIsTransactionListenerActive(false);
                }, 15 * 60 * 1000);
                if (!isTransactionListenerActive) setIsTransactionListenerActive(true);
            };
            useEffect(() => {
                if (!user || view !== 'dashboard') return;
                const events = ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'];
                events.forEach(event => window.addEventListener(event, resetActivityTimer));
                resetActivityTimer(); 
                return () => {
                    if (activityTimerRef.current) clearTimeout(activityTimerRef.current);
                    events.forEach(event => window.removeEventListener(event, resetActivityTimer));
                };
            }, [user, view]);

            // --- INITIALIZE ---
            useEffect(() => {
                const savedQueue = localStorage.getItem('spa_offline_queue');
                if (savedQueue) { try { setOfflineQueue(JSON.parse(savedQueue)); } catch (e) {} }
                const savedUser = localStorage.getItem('spa_user');
                if (savedUser) { try { setUser(JSON.parse(savedUser)); } catch (e) { localStorage.removeItem('spa_user'); } }

                const initFirebase = async () => {
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        const db = firebase.firestore();
                        await auth.signInAnonymously();
                        auth.onAuthStateChanged((u) => { if (u) { setFbUser(u); setFb({ db, auth, appId: currentAppId }); } });
                    } catch (error) { setConfigError(error.message); }
                };
                setTimeout(initFirebase, 500);
                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                return () => { window.removeEventListener('online', () => setIsOnline(true)); window.removeEventListener('offline', () => setIsOnline(false)); };
            }, []);

            useEffect(() => { localStorage.setItem('spa_offline_queue', JSON.stringify(offlineQueue)); }, [offlineQueue]);

            useEffect(() => {
                const syncOfflineQueue = async () => {
                    if (isOnline && offlineQueue.length > 0 && fb) {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        const queueCopy = [...offlineQueue];
                        let syncedCount = 0;
                        setIsGlobalLoading(true);
                        try {
                            for (const item of queueCopy) {
                                const itemPayload = { ...item, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                                delete itemPayload.localId;
                                await fb.db.collection(`${basePath}/transactions`).add(itemPayload);
                                syncedCount++;
                            }
                            setOfflineQueue([]);
                            setModal({ isOpen: true, type: 'alert', title: 'Sync Complete', message: `Successfully uploaded ${syncedCount} offline records.`, confirmColor: 'logo-green', onConfirm: closeModal });
                        } catch (error) {} finally { setIsGlobalLoading(false); }
                    }
                };
                syncOfflineQueue();
            }, [isOnline, fb, offlineQueue.length]);

            useEffect(() => {
                if (!fb || !fbUser) return;
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                const getCollection = (name) => db.collection(`${basePath}/${name}`);
                
                let unsubTrans = () => {};
                if (isTransactionListenerActive && view === 'dashboard') {
                    let query = getCollection('transactions');
                    if (dashboardDate) query = query.where('bookingDate', '==', dashboardDate);
                    unsubTrans = query.onSnapshot((snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            data.sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp));
                            setTransactions(data);
                            setDbReady(true);
                        });
                } else if (view !== 'dashboard' && isTransactionListenerActive) { setIsTransactionListenerActive(false); }

                const unsubUsers = getCollection('users').onSnapshot(async (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (data.length === 0) { seedDefaultUsers(db, basePath); return; }
                    const needsUpdate = data.filter(u => (u.username === 'admin' && u.pin.length < 20));
                    for (const u of needsUpdate) { if (u.pin === '8888' || u.pin === '888888') { const hashedPin = await hashPin('888888'); await getCollection('users').doc(u.id).update({ pin: hashedPin, role: 'admin' }); } }
                    setUsers(data);
                });

                // SAFE SORTING TO PREVENT CRASHES ON MISSING NAMES
                const unsubTherapists = getCollection('therapists').onSnapshot((snapshot) => { setTherapistsList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.name || '').localeCompare(b.name || ''))); });
                const unsubServices = getCollection('services').onSnapshot((snapshot) => { setServicesList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.name || '').localeCompare(b.name || ''))); });
                const unsubDurations = getCollection('durations').onSnapshot((snapshot) => { setDurationsList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (parseInt(a.name) || 0) - (parseInt(b.name) || 0))); });
                const unsubDrivers = getCollection('drivers').onSnapshot((snapshot) => { setDriversList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.name || '').localeCompare(b.name || ''))); });
                const unsubRooms = getCollection('rooms').onSnapshot((snapshot) => { setRoomsList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.name || '').localeCompare(b.name || ''))); });

                return () => { unsubTrans(); unsubUsers(); unsubTherapists(); unsubServices(); unsubDurations(); unsubDrivers(); unsubRooms(); };
            }, [fb, fbUser, isTransactionListenerActive, view, dashboardDate]); 

            useEffect(() => {
                if (!fb || !fbUser || view !== 'history') { if (history.length > 0) setHistory([]); return; }
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                db.collection(`${basePath}/history`).orderBy('timestamp_val', 'desc').limit(50).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setHistory(data);
                });
            }, [fb, fbUser, view]); 

            // Group services
            const groupedServices = useMemo(() => {
                const groups = {};
                SERVICE_CATEGORIES.forEach(cat => groups[cat] = []);
                servicesList.forEach(s => {
                    const cat = s.category || 'Others';
                    if (!groups[cat]) groups[cat] = [s]; else groups[cat].push(s);
                });
                return groups;
            }, [servicesList]);

            const seedDefaultUsers = async (db, basePath) => {
                const defaults = [{ name: 'Owner Admin', username: 'admin', pin: '888888', role: 'admin' }, { name: 'Morning Rec.', username: 'morning', pin: '1111', role: 'staff' }];
                const userColl = db.collection(`${basePath}/users`);
                const usersToSeed = await Promise.all(defaults.map(async u => { const hashedPin = await hashPin(u.pin); return { ...u, pin: hashedPin }; }));
                for (const u of usersToSeed) await userColl.add(u);
            };

            const calculatePrice = (serviceName, durationName, transport = 0) => {
                let basePrice = 0;
                if (serviceName) {
                    const foundService = servicesList.find(s => s.name === serviceName);
                    if (foundService) {
                        if (durationName && foundService.prices && foundService.prices[durationName]) basePrice = foundService.prices[durationName];
                        else if (foundService.price) basePrice = foundService.price;
                    }
                }
                return basePrice + Number(transport);
            };

            const toggleTherapistSelection = (name) => {
                if (selectedTherapists.includes(name)) {
                    setSelectedTherapists(prev => prev.filter(t => t !== name));
                    setTherapistRows(prev => { const copy = { ...prev }; delete copy[name]; return copy; });
                } else {
                    setSelectedTherapists(prev => [...prev, name]);
                    setTherapistRows(prev => ({ ...prev, [name]: { service: formData.service, duration: formData.duration, amount: formData.amount } }));
                }
            };

            const updateTherapistRow = (name, field, value) => {
                setTherapistRows(prev => {
                    const updatedRow = { ...(prev[name] || {}), [field]: value };
                    if (field === 'service' || field === 'duration') {
                        const sName = field === 'service' ? value : (updatedRow.service || formData.service);
                        const dName = field === 'duration' ? value : (updatedRow.duration || formData.duration);
                        updatedRow.amount = calculatePrice(sName, dName, 0);
                    }
                    return { ...prev, [name]: updatedRow };
                });
            };

            const toggleDriverSelection = (name) => {
                if (selectedDrivers.includes(name)) setSelectedDrivers(prev => prev.filter(d => d !== name));
                else setSelectedDrivers(prev => [...prev, name]);
            };

            const handleDurationChange = (val) => {
                const newPrice = calculatePrice(formData.service, val, formData.transportFee);
                setFormData({ ...formData, duration: val, amount: newPrice });
            };

            const handleSubmit = async (e, typeOverride = null) => {
                e.preventDefault();
                const transactionType = typeOverride || formData.type;
                const transactionBranch = user.currentBranch === 'ALL' ? formData.targetBranch : user.currentBranch;

                if (user.currentBranch === 'ALL' && !formData.targetBranch) { setModal({ isOpen: true, type: 'alert', title: 'Missing Branch', message: 'Select Target Branch.', confirmColor: 'red', onConfirm: closeModal }); return; }

                const transactionsToSave = [];
                let baseAmount = parseFloat(formData.amount) || 0;
                if (transactionType === 'expense') {
                    if (!formData.amount || !formData.category || !formData.notes) { setModal({ isOpen: true, type: 'alert', title: 'Missing Info', message: 'Fill all expense fields.', confirmColor: 'red', onConfirm: closeModal }); return; }
                    baseAmount = -Math.abs(baseAmount);
                    transactionsToSave.push({
                        clientName: formData.category, description: formData.notes, category: formData.category, amount: baseAmount, type: transactionType,
                        status: 'completed', time: formData.time, bookingDate: formData.bookingDate, recordedBy: user.name, branch: transactionBranch, notes: formData.notes.trim(), location: formData.location || 'spa'
                    });
                } else {
                    if (!formData.clientName) { setModal({ isOpen: true, type: 'alert', title: 'Missing Info', message: 'Enter Client Name.', confirmColor: 'red', onConfirm: closeModal }); return; }
                    if (selectedTherapists.length === 0) { setModal({ isOpen: true, type: 'alert', title: 'Missing Therapist', message: 'Add at least one Therapist.', confirmColor: 'red', onConfirm: closeModal }); return; }
                    
                    for (const name of selectedTherapists) {
                        const row = therapistRows[name];
                        if (!row || !row.service || !row.duration) { setModal({ isOpen: true, type: 'alert', title: 'Missing Details', message: `Set Service/Price for ${name}.`, confirmColor: 'red', onConfirm: closeModal }); return; }
                    }

                    const splitTransport = selectedTherapists.length > 0 ? ((parseFloat(formData.transportFee) || 0) / selectedTherapists.length) : 0;
                    const driverString = selectedDrivers.length > 0 ? selectedDrivers.join(', ') : '';

                    selectedTherapists.forEach(thName => {
                        const row = therapistRows[thName];
                        const rowAmount = parseFloat(row.amount) || 0;
                        transactionsToSave.push({
                            clientName: formData.clientName, clientContact: formData.clientContact, description: formData.notes, service: row.service, therapist: thName,
                            amount: rowAmount + splitTransport, duration: row.duration, type: transactionType, status: transactionType === 'sale' ? 'completed' : 'pending',
                            time: formData.time, bookingDate: formData.bookingDate, recordedBy: user.name, branch: transactionBranch, notes: formData.notes.trim(),
                            location: formData.location || 'spa', transportFee: splitTransport, driver: formData.location === 'home' ? driverString : '', room: formData.location === 'spa' ? formData.room : '', paymentMethod: formData.paymentMethod
                        });
                    });
                }

                setIsGlobalLoading(true);
                try {
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    const promises = transactionsToSave.map(t => fb.db.collection(`${basePath}/transactions`).add({ ...t, timestamp: firebase.firestore.FieldValue.serverTimestamp() }));
                    await Promise.all(promises);
                    
                    setFormData({ clientName: '', clientContact: '', service: '', duration: '', therapist: '', amount: '', type: 'booking', time: new Date().toTimeString().slice(0, 5), targetBranch: user.currentBranch === 'ALL' ? transactionBranch : user.currentBranch, notes: '', category: '', bookingDate: new Date().toISOString().split('T')[0], location: 'spa', transportFee: '', driver: '', room: '', paymentMethod: 'Cash' });
                    setSelectedTherapists([]); setSelectedDrivers([]); setTherapistRows({});
                    setModal({ isOpen: true, type: 'alert', title: 'Saved!', message: `${transactionsToSave.length} record(s) saved.`, confirmColor: 'logo-green', onConfirm: closeModal });
                    setView('dashboard');
                } catch (error) { setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to save.', confirmColor: 'red', onConfirm: closeModal }); } 
                finally { setIsGlobalLoading(false); }
            };

            const downloadCSV = (record) => {
                const headers = ['Date','Branch','Time','Client Name','Client Contact','Service','Duration','Therapist','Driver','Location','Room','Payment','Transport','Total','Commission','Status','Recorded By','Notes'];
                let dateStr = record.date; try { dateStr = new Date(record.date).toLocaleDateString(); } catch(e){}
                
                const rows = record.transactions.map(t => {
                    let comm = 0;
                    if (t.type!=='expense' && t.status!=='pending' && t.therapist && record.therapist_stats?.[t.branch || 'Unknown']) {
                        const thData = record.therapist_stats[t.branch || 'Unknown'].find(s=>s.name===t.therapist.trim());
                        if (thData) comm = (Number(t.amount) - Number(t.transportFee||0)) * (thData.rate/100);
                    }
                    return [`"${dateStr}"`,`"${t.branch||''}"`,`"${t.time}"`,`"${t.clientName||t.category}"`,`"${t.clientContact||''}"`,`"${t.service||t.category}"`,`"${t.duration||''}"`,`"${t.therapist||''}"`,`"${t.driver||''}"`,`"${t.location}"`,`"${t.room||''}"`,`"${t.paymentMethod||'Cash'}"`,t.transportFee||0,t.amount,comm.toFixed(2),t.status,`"${t.recordedBy}"`,`"${t.notes||''}"`];
                });
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csvContent], {type: 'text/csv;charset=utf-8;'}));
                link.download = `Report_${record.date}.csv`; link.click();
            };

            // Login Logic
            const handleLogin = async (e) => {
                e.preventDefault();
                setIsGlobalLoading(true);
                try {
                    const hashed = await hashPin(loginPin);
                    const found = users.find(u => u.username.toLowerCase() === loginUsername.toLowerCase() && u.pin === hashed);
                    if (found) {
                        if (loginBranch === 'ALL' && found.role !== 'admin') { setModal({isOpen:true, type:'alert', title:'Access Denied', message:'Admin only.', confirmColor:'red', onConfirm:closeModal}); return; }
                        const loggedUser = { ...found, currentBranch: loginBranch };
                        await fb.db.collection(`artifacts/${fb.appId}/public/data/users`).doc(found.id).update({ currentBranch: loginBranch, lastActive: firebase.firestore.FieldValue.serverTimestamp() });
                        setUser(loggedUser); localStorage.setItem('spa_user', JSON.stringify(loggedUser)); setView('dashboard');
                    } else setModal({isOpen:true, type:'alert', title:'Failed', message:'Check credentials.', confirmColor:'red', onConfirm:closeModal});
                } catch(err) { setModal({isOpen:true, type:'alert', title:'Error', message:'Login error.', confirmColor:'red', onConfirm:closeModal}); }
                finally { setIsGlobalLoading(false); }
            };

            if (!user) return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-logo-green-100 text-center relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-logo-green-700 to-teal-600"></div>
                        <h1 className="text-3xl font-extrabold text-logo-green-900 mb-1">AHMAS System</h1><p className="text-slate-500 mb-6 text-sm">Staff Portal</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div className="relative"><Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" /><select required value={loginBranch} onChange={(e)=>setLoginBranch(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-slate-50"><option value="" disabled>Select Branch</option>{BRANCHES.map(b=><option key={b} value={b}>{b}</option>)}<option value="ALL">ALL BRANCHES</option></select></div>
                            <div className="relative"><Icons.User size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required value={loginUsername} onChange={(e)=>setLoginUsername(e.target.value)} placeholder="Username" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-slate-50"/></div>
                            <div className="relative"><Icons.Fingerprint size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required type="password" inputMode="numeric" value={loginPin} onChange={(e)=>setLoginPin(e.target.value)} placeholder="PIN" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-slate-50"/></div>
                            <button className="w-full bg-logo-green-700 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Login</button>
                        </form>
                    </div>
                    {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end"><button onClick={closeModal} className="px-4 py-2 rounded bg-logo-green-600 text-white">Okay</button></div></div></div>}
                    {isGlobalLoading && <LoadingOverlay message="Verifying..." />}
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-24 relative fade-in">
                    <header className="bg-white border-b border-logo-green-100 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3"><h1 className="text-xl font-extrabold text-logo-green-800">AHMAS System</h1><span className="text-[10px] font-bold bg-logo-green-100 text-logo-green-700 px-2 py-0.5 rounded flex items-center gap-1"><Icons.MapPin size={10}/> {user.currentBranch}</span></div>
                            <button onClick={()=>{ setUser(null); localStorage.removeItem('spa_user'); }} className="p-2 text-slate-400 hover:text-red-500 rounded-lg"><Icons.LogOut size={20}/></button>
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto px-4 py-6">
                        <div className="flex p-1 bg-slate-200/60 rounded-xl mb-6 sticky top-[70px] z-10 backdrop-blur-sm overflow-x-auto">
                            {['dashboard', 'add', 'expense', 'profile', 'history'].map(v => (
                                <button key={v} onClick={()=>setView(v)} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col items-center gap-1 capitalize ${view===v?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}>{v}</button>
                            ))}
                            {user.role === 'admin' && (
                                <>
                                    <button onClick={()=>setView('lists')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col items-center gap-1 ${view==='lists'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}>Lists</button>
                                    <button onClick={()=>setView('team')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col items-center gap-1 ${view==='team'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}>Team</button>
                                </>
                            )}
                        </div>

                        {view === 'add' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-logo-green-100 p-6 fade-in">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Icons.Plus size={24} className="text-logo-green-700"/> New Booking</h2>
                                <form onSubmit={handleSubmit} className="space-y-5">
                                    <div className="grid grid-cols-2 gap-3 bg-slate-100 p-1.5 rounded-xl">
                                        {['spa', 'home'].map(loc => (
                                            <button key={loc} type="button" onClick={() => {
                                                const transportVal = loc === 'spa' ? 0 : (parseFloat(formData.transportFee) || 0);
                                                const newPrice = calculatePrice(formData.service, formData.duration, transportVal);
                                                setFormData({ ...formData, location: loc, transportFee: loc === 'spa' ? '' : formData.transportFee, driver: loc === 'spa' ? '' : formData.driver, room: loc === 'home' ? '' : formData.room, amount: newPrice });
                                            }} className={`py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 capitalize ${formData.location === loc ? 'bg-white text-logo-green-700 shadow-sm' : 'text-slate-400'}`}>
                                                {loc}
                                            </button>
                                        ))}
                                    </div>

                                    {formData.location === 'spa' && (
                                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 animate-fadeIn">
                                            <label className="text-xs font-bold text-slate-500 mb-1 block flex items-center gap-1"><Icons.DoorOpen size={12}/> Assigned Room</label>
                                            <select value={formData.room} onChange={e => setFormData({...formData, room: e.target.value})} className="w-full p-2 rounded-lg border border-slate-200 bg-white text-sm"><option value="">Select Room (Optional)</option>{roomsList.map(r => <option key={r.id} value={r.name}>{r.name}</option>)}</select>
                                        </div>
                                    )}

                                    {formData.location === 'home' && (
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 animate-fadeIn space-y-4">
                                            <div><label className="text-xs font-bold text-blue-700 mb-1 block">Transport (Total)</label><input type="number" placeholder="0.00" value={formData.transportFee} onChange={e => { const val = parseFloat(e.target.value) || 0; const newPrice = calculatePrice(formData.service, formData.duration, val); setFormData({ ...formData, transportFee: e.target.value, amount: newPrice }); }} className="w-full p-2 rounded-lg border border-blue-200 bg-white"/></div>
                                            <div>
                                                <label className="text-xs font-bold text-blue-700 mb-1 block">Drivers</label>
                                                <div className="flex flex-wrap gap-2 mb-2">{selectedDrivers.map(d => <span key={d} className="bg-white text-blue-600 text-xs px-2 py-1 rounded border border-blue-200 flex items-center gap-1">{d} <button type="button" onClick={() => toggleDriverSelection(d)}><Icons.X size={12}/></button></span>)}</div>
                                                <select value="" onChange={e => { if(e.target.value) toggleDriverSelection(e.target.value); }} className="w-full p-2 rounded-lg border border-blue-200 bg-white text-sm"><option value="">+ Add Driver</option>{driversList.filter(d => !selectedDrivers.includes(d.name)).map(d => <option key={d.id} value={d.name}>{d.name}</option>)}</select>
                                            </div>
                                        </div>
                                    )}

                                    <div className="space-y-2">
                                        <input required placeholder="Client Name*" value={formData.clientName} onChange={e=>setFormData({...formData, clientName:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                        <input placeholder="Client Contact No." value={formData.clientContact} onChange={e=>setFormData({...formData, clientContact:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                    </div>

                                    {/* Duration Dropdown (Global) */}
                                    <select value={formData.duration} onChange={e=>handleDurationChange(e.target.value)} className="w-full p-3 border rounded-xl bg-slate-50 appearance-none font-bold text-slate-700">
                                        <option value="" disabled>Select Duration (Applied to all)</option>
                                        {durationsList.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                                    </select>

                                    {/* Therapist Multi Select */}
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase flex justify-between"><span>Therapists & Services</span><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded">{selectedTherapists.length} Added</span></label>
                                        {selectedTherapists.map(name => (
                                            <div key={name} className="w-full bg-white border border-logo-green-200 shadow-sm rounded-xl p-3 flex flex-col gap-2 relative">
                                                <div className="flex justify-between items-center border-b border-slate-50 pb-2"><span className="font-bold text-logo-green-800 text-sm">{name}</span><button type="button" onClick={() => toggleTherapistSelection(name)}><Icons.X size={18} className="text-slate-300 hover:text-red-500"/></button></div>
                                                <div className="flex flex-col gap-2">
                                                    <select value={therapistRows[name]?.service || ''} onChange={(e) => updateTherapistRow(name, 'service', e.target.value)} className="text-xs p-2 border rounded-lg bg-slate-50 w-full">
                                                        <option value="" disabled>Select Service*</option>
                                                        {Object.entries(groupedServices).map(([cat, svcs]) => <optgroup key={cat} label={cat}>{svcs.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</optgroup>)}
                                                    </select>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <select value={therapistRows[name]?.duration || ''} onChange={(e) => updateTherapistRow(name, 'duration', e.target.value)} className="text-xs p-2 border rounded-lg bg-slate-50"><option value="" disabled>Duration</option>{durationsList.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}</select>
                                                        <input type="number" value={therapistRows[name]?.amount || ''} onChange={(e) => updateTherapistRow(name, 'amount', e.target.value)} className="w-full text-xs p-2 border rounded-lg bg-slate-50 font-bold" placeholder="0.00"/>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        <div className="relative">
                                            <select value="" onChange={e => { if(e.target.value) toggleTherapistSelection(e.target.value); }} className="w-full p-3 pl-10 border rounded-xl bg-slate-50 appearance-none font-bold text-logo-green-700">
                                                <option value="">+ Add Therapist</option>
                                                {therapistsList.filter(t => !selectedTherapists.includes(t.name)).map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                            </select>
                                            <Icons.Plus size={18} className="absolute left-3 top-3.5 text-logo-green-600 pointer-events-none"/>
                                        </div>
                                    </div>

                                    <textarea placeholder="Service Notes..." rows="2" value={formData.notes} onChange={e=>setFormData({...formData, notes:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 text-sm"/>

                                    <div className="grid grid-cols-2 gap-4 items-center">
                                        <input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 text-center font-bold"/>
                                        <div className="text-right">
                                            <p className="text-[10px] text-slate-400 uppercase font-bold">Total Estimate</p>
                                            <p className="text-2xl font-extrabold text-logo-green-700">{formatCurrency(selectedTherapists.reduce((acc, name) => acc + (parseFloat(therapistRows[name]?.amount) || 0), 0) + (parseFloat(formData.transportFee) || 0))}</p>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-2 block uppercase">Payment Method</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {[{l:'Cash',i:<Icons.Banknote/>},{l:'GCash',i:<Icons.Smartphone/>},{l:'Maya',i:<Icons.Smartphone/>},{l:'BPI',i:<Icons.Landmark/>},{l:'Eastwest Bank',i:<Icons.Landmark/>}].map(m => (
                                                <button type="button" key={m.l} onClick={() => setFormData({ ...formData, paymentMethod: m.l })} className={`p-3 rounded-xl border flex flex-col items-center gap-1 text-[10px] font-bold ${formData.paymentMethod === m.l ? 'bg-slate-800 text-white' : 'bg-white text-slate-400'}`}>{m.i}<span>{m.l}</span></button>
                                            ))}
                                        </div>
                                    </div>

                                    <button className="w-full bg-logo-green-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2">Save Booking</button>
                                </form>
                            </div>
                        )}

                        {view === 'dashboard' && (
                            <div className="space-y-6 fade-in">
                                <div className="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                                    <button onClick={() => { const d = new Date(dashboardDate); d.setDate(d.getDate() - 1); setDashboardDate(d.toISOString().split('T')[0]); }} className="p-2 text-slate-400"><Icons.ChevronDown className="rotate-90"/></button>
                                    <div className="text-center">
                                        <label className="text-[10px] text-slate-400 font-bold uppercase">Viewing Date</label>
                                        <input type="date" value={dashboardDate} onChange={(e) => setDashboardDate(e.target.value)} className="font-bold text-lg text-slate-700 bg-transparent text-center focus:outline-none"/>
                                        {dashboardDate === getTodayStr() && <span className="block text-[10px] text-green-500 font-bold bg-green-50 rounded-full px-2 mt-1">TODAY</span>}
                                    </div>
                                    <button onClick={() => { const d = new Date(dashboardDate); d.setDate(d.getDate() + 1); setDashboardDate(d.toISOString().split('T')[0]); }} className="p-2 text-slate-400"><Icons.ChevronDown className="-rotate-90"/></button>
                                </div>

                                <div className="grid grid-cols-3 gap-3">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100"><p className="text-slate-500 text-xs font-medium uppercase">Sales</p><h3 className="text-xl font-bold text-slate-800 mt-1">{formatCurrency(stats.totalRevenue)}</h3></div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100"><p className="text-slate-500 text-xs font-medium uppercase">Exp</p><h3 className="text-xl font-bold text-red-600 mt-1">{formatCurrency(stats.totalExpenses)}</h3></div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100 border-l-[3px] border-logo-green-500"><p className="text-slate-500 text-xs font-medium uppercase">Net</p><h3 className="text-xl font-bold text-logo-green-700 mt-1">{formatCurrency(stats.netCash)}</h3></div>
                                </div>

                                <div className="space-y-3">
                                    {filteredTransactions.map(t=>(
                                        <div key={t.id} className={`bg-white p-4 rounded-xl border-l-[6px] shadow-sm flex justify-between items-start ${t.type === 'expense' ? 'border-l-red-500' : (t.status==='completed'?'border-l-logo-green-500':'border-l-orange-400')}`}>
                                            <div className="flex-1 pr-4">
                                                <div className="flex gap-2 mb-1 items-center">
                                                    <span className="text-[10px] font-bold bg-slate-100 px-2 rounded text-slate-500">{t.branch}</span>
                                                    <span className="text-xs font-mono text-slate-400">{t.bookingDate || formatDate(t.timestamp)} - {t.time}</span>
                                                    {t.location === 'home' && <span className="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 rounded flex items-center gap-1"><Icons.Car size={10}/> Home {t.driver && <span className="font-normal text-blue-600">via {t.driver}</span>}</span>}
                                                    {t.location === 'spa' && t.room && <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 rounded flex items-center gap-1"><Icons.DoorOpen size={10}/> Rm: {t.room}</span>}
                                                </div>
                                                <h3 className={`font-bold ${t.type === 'expense' ? 'text-red-700' : 'text-slate-800'}`}>
                                                    {t.type === 'expense' ? t.category : t.clientName}
                                                    {t.clientContact && t.type !== 'expense' && <span className="text-xs font-normal text-slate-500 ml-2"><Icons.User size={10} className="inline"/> {t.clientContact}</span>}
                                                </h3>
                                                <div className="text-xs text-slate-500 mt-1 flex gap-2 flex-wrap items-center">
                                                    {t.type === 'expense' ? <span>{t.notes}</span> : (
                                                        <><span>{t.service}</span>{t.duration && <span>  {t.duration}</span>}<span>  {t.therapist}</span>
                                                        {t.paymentMethod && <span className="ml-1 px-1.5 py-0.5 rounded border text-[9px] font-bold uppercase bg-slate-50 border-slate-200">{t.paymentMethod}</span>}
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="text-right min-w-[80px]">
                                                <div className={`font-bold text-lg ${t.type === 'expense' ? 'text-red-600' : 'text-slate-800'}`}>{formatCurrency(t.amount)}</div>
                                                <div className="flex justify-end gap-2 mt-1">
                                                    {t.type !== 'expense' && <button onClick={()=>toggleStatus(t)} className={`p-1.5 rounded-full ${t.status==='completed'?'bg-logo-green-100 text-logo-green-700':'bg-orange-100 text-orange-600'}`}>{t.status==='completed'?<Icons.CheckCircle2 size={16}/>:<Icons.DollarSign size={16}/>}</button>}
                                                    {user.role==='admin'&&<button onClick={()=>requestDelete(t.id)} className="p-1.5 text-slate-300 hover:text-red-500"><Icons.Trash2 size={16}/></button>}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                        {isGlobalLoading && <LoadingOverlay message="Processing..." />}
                    </main>
                    {view === 'dashboard' && <button onClick={()=>setView('add')} className="fixed bottom-6 right-6 bg-logo-green-700 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform"><Icons.Plus size={28}/></button>}
                    
                    <AdminResetUserModal editUserModal={editUserModal} setEditUserModal={setEditUserModal} handleResetPin={handleResetPin} userRole={user?.role} />
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
