<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Custom Tailwind Configuration to use the Logo's Primary Green (#008000)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6',      // Very light background
                            100: '#CCFFCC',      // Light background
                            500: '#00B300',      // Medium
                            600: '#009900',      // Primary Button Hover
                            700: '#008000',      // Base Logo Green / Primary
                            800: '#006600',      // Darker text/header
                            900: '#004C00',      // Deepest text
                        },
                        'teal': {
                            600: '#008080', // Keep some teal accent for contrast
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #008000; /* Use logo-green */
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .loader-lg {
            width: 48px;
            height: 48px;
            border-width: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Style for better appearance of select arrows in Tailwind */
        select {
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const BRANCHES = [
            'Guadalupe',  
            'Mabolo',  
            'Talisay',  
            'Bacayan',  
            'Lapu-lapu',  
            'AS Fortuna'
        ];

        // Service Categories
        const SERVICE_CATEGORIES = [
            'Specialized Massage',
            'Relax & Revive',
            'Premium Massage',
            'Add-ons',
            'Others'
        ];
        
        // --- FIREBASE CONFIGURATION ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKfftJL6ZkFCdxVT5wyWWPqtvPd2eRLJk",
            authDomain: "ahmas-system.firebaseapp.com",
            databaseURL: "https://ahmas-system-default-rtdb.firebaseio.com",
            projectId: "ahmas-system",
            storageBucket: "ahmas-system.firebasestorage.app",
            messagingSenderId: "3535933918",
            appId: "1:3535933918:web:24eb6311bd0c49750b0d4f",
            measurementId: "G-D8SXDWE6SW"
        };
        
        const firebaseConfig = MANUAL_FIREBASE_CONFIG;
        const currentAppId = firebaseConfig.projectId;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons({
                        root: wrapperRef.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, class: className, ...props }
                    });
                }
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="layout-dashboard" {...p} />,
            Plus: (p) => <Icon name="plus" {...p} />,
            DollarSign: (p) => <Icon name="dollar-sign" {...p} />,
            Calendar: (p) => <Icon name="calendar" {...p} />,
            CheckCircle2: (p) => <Icon name="check-circle-2" {...p} />,
            Clock: (p) => <Icon name="clock" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />,
            Users: (p) => <Icon name="users" {...p} />,
            Sparkles: (p) => <Icon name="sparkles" {...p} />,
            Home: (p) => <Icon name="home" {...p} />,
            Building2: (p) => <Icon name="building-2" {...p} />,
            Car: (p) => <Icon name="car" {...p} />,
            UserCircle2: (p) => <Icon name="user-circle-2" {...p} />,
            History: (p) => <Icon name="history" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            ChevronUp: (p) => <Icon name="chevron-up" {...p} />,
            Archive: (p) => <Icon name="archive" {...p} />,
            AlertTriangle: (p) => <Icon name="alert-triangle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            LogOut: (p) => <Icon name="log-out" {...p} />,
            Lock: (p) => <Icon name="lock" {...p} />,
            ShieldCheck: (p) => <Icon name="shield-check" {...p} />,
            UserPlus: (p) => <Icon name="user-plus" {...p} />,
            User: (p) => <Icon name="user" {...p} />,
            Fingerprint: (p) => <Icon name="fingerprint" {...p} />,
            UserCog: (p) => <Icon name="user-cog" {...p} />,
            Cloud: (p) => <Icon name="cloud" {...p} />,
            WifiOff: (p) => <Icon name="wifi-off" {...p} />,
            Trophy: (p) => <Icon name="trophy" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />,
            Tag: (p) => <Icon name="tag" {...p} />,
            Hourglass: (p) => <Icon name="hourglass" {...p} />,
            Pencil: (p) => <Icon name="pencil" {...p} />,
            Loader2: (p) => <Icon name="loader-2" {...p} />,
            ClipboardList: (p) => <Icon name="clipboard-list" {...p} />,
            MinusCircle: (p) => <Icon name="minus-circle" {...p} />,
            Wallet: (p) => <Icon name="wallet" {...p} />,
            TrendingUp: (p) => <Icon name="trending-up" {...p} />,
            SteeringWheel: (p) => <Icon name="joystick" {...p} />, // Using joystick as proxy for steering wheel or car front
            DoorOpen: (p) => <Icon name="door-open" {...p} />, // Icon for Rooms
            CreditCard: (p) => <Icon name="credit-card" {...p} />, // Card
            Smartphone: (p) => <Icon name="smartphone" {...p} />, // GCash/Phone
            Banknote: (p) => <Icon name="banknote" {...p} />, // Cash
            Landmark: (p) => <Icon name="landmark" {...p} />, // Bank
            Map: (p) => <Icon name="map" {...p} />
        };

        // --- SECURITY HELPER: Hashing Function ---
        const hashPin = async (pin) => {
            if (!pin || pin.length < 4) return null;
            try {
                // Use subtle crypto for SHA-256 hashing
                const msgUint8 = new TextEncoder().encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            } catch (error) {
                console.error("Hashing failed:", error);
                return null;
            }
        };

        // --- SECURITY HELPER: Timestamp Normalizer ---
        const getMillis = (ts) => {
            if (!ts) return Date.now(); // Treat pending/null as "now" so it appears at the top
            if (typeof ts === 'number') return ts; // Legacy or client-side number
            if (typeof ts.toMillis === 'function') return ts.toMillis(); // Firestore Timestamp object (V9+)
            if (ts.seconds) return ts.seconds * 1000; // Raw object fallback (V8/Compat)
            return 0;
        };

        // --- DATE HELPER ---
        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Loading Component ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 min-w-[200px]">
                    <div className="loader loader-lg"></div>
                    <p className="text-slate-600 font-semibold text-sm animate-pulse">{message || 'Processing...'}</p>
                </div>
            </div>
        );

        // --- List Management Component (Admin Only) ---
        const ListManagement = ({ therapists, services, durations, drivers, rooms, discounts, onAdd, onDelete, onEdit }) => {
            const [activeTab, setActiveTab] = useState('therapist');  
            
            // Add State
            const [newItemName, setNewItemName] = useState('');
            const [newItemCategory, setNewItemCategory] = useState(SERVICE_CATEGORIES[0]); 
            const [newItemPrices, setNewItemPrices] = useState({});  
            const [newItemCommission, setNewItemCommission] = useState('');  
            
            // Edit State
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPrices, setEditPrices] = useState({});
            const [editCommission, setEditCommission] = useState('');  

            // Discount specific fields (re-using general states for simplicity in single component)
            const [newDiscountType, setNewDiscountType] = useState('Percentage');
            const [newDiscountValue, setNewDiscountValue] = useState('');
            const [newDiscountCode, setNewDiscountCode] = useState('');


            const [modal, setModal] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red' });
            const closeModal = () => setModal({ ...modal, isOpen: false });
            
            const isServiceAddDisabled = activeTab === 'service' && durations.length === 0;

            const handleFormSubmit = (e) => {
                e.preventDefault();
                let extraData = null;

                if (activeTab === 'service') {
                    if (durations.length === 0) return; 
                    extraData = { prices: newItemPrices, category: newItemCategory };
                } else if (activeTab === 'therapist') {
                    extraData = { commissionRate: parseFloat(newItemCommission) || 0 };
                } else if (activeTab === 'discount') { 
                    const discountValue = parseFloat(newDiscountValue);
                    if (isNaN(discountValue) || discountValue <= 0) {
                         setModal({ isOpen: true, type: 'alert', title: 'Invalid Value', message: 'Discount value must be a positive number.', onConfirm: closeModal, confirmColor: 'red' });
                         return;
                    }
                    extraData = { 
                        type: newDiscountType, 
                        value: discountValue,
                        code: newDiscountCode.trim() 
                    };
                } else if (activeTab === 'duration' || activeTab === 'driver' || activeTab === 'room') {
                    // No extra data needed for these, just name
                }

                onAdd(activeTab, newItemName, extraData);
                setNewItemName('');
                setNewItemPrices({});
                setNewItemCommission(''); 
                setNewDiscountType('Percentage');
                setNewDiscountValue('');
                setNewDiscountCode('');
            };
            
            const startEdit = (item) => {
                setEditingId(item.id);
                setEditName(item.name);
                setEditPrices(item.prices || {});
                setEditCommission(item.commissionRate !== undefined ? String(item.commissionRate) : '');  
                
                // Set discount edit fields
                if (activeTab === 'discount') {
                    setNewDiscountType(item.type || 'Percentage');
                    setNewDiscountValue(String(item.value || 0));
                    setNewDiscountCode(item.code || '');
                }
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditName('');
                setEditPrices({});
                setEditCommission('');
                setNewDiscountType('Percentage');
                setNewDiscountValue('');
                setNewDiscountCode('');
            };

            const saveEdit = () => {
                const updatedData = { name: editName.trim() };
                if (activeTab === 'service') {
                    const currentItem = services.find(s => s.id === editingId);
                    updatedData.prices = editPrices;
                    updatedData.category = currentItem.category || 'Others'; 
                } else if (activeTab === 'therapist') {  
                    updatedData.commissionRate = parseFloat(editCommission) || 0;
                } else if (activeTab === 'discount') {
                    const discountValue = parseFloat(newDiscountValue);
                    if (isNaN(discountValue) || discountValue <= 0) {
                         setModal({ isOpen: true, type: 'alert', title: 'Invalid Value', message: 'Discount value must be a positive number.', onConfirm: closeModal, confirmColor: 'red' });
                         return;
                    }
                    updatedData.type = newDiscountType;
                    updatedData.value = discountValue;
                    updatedData.code = newDiscountCode.trim();
                }
                
                onEdit(activeTab, editingId, updatedData);
                setEditingId(null);
            };

            const handlePriceChange = (durationName, val, isEdit = false) => {
                const setter = isEdit ? setEditPrices : setNewItemPrices;
                const current = isEdit ? editPrices : newItemPrices;
                
                const numberVal = parseFloat(val);

                if (!val || isNaN(numberVal) || numberVal < 0) {
                    const copy = { ...current };
                    delete copy[durationName];
                    setter(copy);
                } else {
                    setter({ ...current, [durationName]: numberVal });
                }
            };

            let currentList = [];
            let placeholderText = "";
            let icon = null;

            if (activeTab === 'therapist') {
                currentList = therapists;
                placeholderText = "Enter Therapist Name";
                icon = <Icons.Users size={18} />;
            } else if (activeTab === 'service') {
                currentList = services;
                placeholderText = "Enter Service Name (e.g. Swedish)";
                icon = <Icons.Tag size={18} />;
            } else if (activeTab === 'duration') {
                currentList = durations;
                placeholderText = "Enter Duration (e.g. 60 Mins)";
                icon = <Icons.Hourglass size={18} />;
            } else if (activeTab === 'driver') {
                currentList = drivers;
                placeholderText = "Enter Driver Name";
                icon = <Icons.Car size={18} />;
            } else if (activeTab === 'room') { 
                currentList = rooms;
                placeholderText = "Enter Room Name/Number";
                icon = <Icons.DoorOpen size={18} />;
            } else if (activeTab === 'discount') { // NEW
                currentList = discounts;
                placeholderText = "Enter Discount Name (e.g. Senior Citizen)";
                icon = <Icons.MinusCircle size={18} />;
            }

            return (
                <div className="space-y-6 fade-in">
                    <h2 className="text-lg font-bold text-logo-green-800 flex gap-2 items-center"><Icons.ShieldCheck size={18} className="text-logo-green-700"/> Master Data Lists</h2>
                    
                    {/* Tabs */}
                    <div className="flex bg-slate-100 p-1 rounded-lg overflow-x-auto">
                        <button onClick={() => setActiveTab('therapist')} className={`flex-1 py-2 px-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 min-w-[90px] ${activeTab==='therapist' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Users size={14}/> Therapists
                        </button>
                        <button onClick={() => setActiveTab('room')} className={`flex-1 py-2 px-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 min-w-[80px] ${activeTab==='room' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.DoorOpen size={14}/> Rooms
                        </button>
                        <button onClick={() => setActiveTab('driver')} className={`flex-1 py-2 px-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 min-w-[80px] ${activeTab==='driver' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Car size={14}/> Drivers
                        </button>
                        <button onClick={() => setActiveTab('duration')} className={`flex-1 py-2 px-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 min-w-[80px] ${activeTab==='duration' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Clock size={14}/> Minutes
                        </button>
                        <button onClick={() => setActiveTab('service')} className={`flex-1 py-2 px-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 min-w-[80px] ${activeTab==='service' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Sparkles size={14}/> Services
                        </button>
                         <button onClick={() => setActiveTab('discount')} className={`flex-1 py-2 px-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 min-w-[80px] ${activeTab==='discount' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Tag size={14}/> Discounts
                        </button>
                    </div>

                    {/* Add New Item */}
                    <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6">
                        <h3 className="font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide text-slate-500"><Icons.Plus size={16}/> Add New {activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}</h3>
                        <form onSubmit={handleFormSubmit} className="flex flex-col gap-3">
                            <div className="flex gap-2">
                                <input 
                                    required  
                                    placeholder={placeholderText}  
                                    value={newItemName}  
                                    onChange={e => setNewItemName(e.target.value)}  
                                    className="flex-1 p-3 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-logo-green-500 outline-none"
                                />
                            </div>
                            
                            {/* Dynamic Price Inputs for Services */}
                            {activeTab === 'service' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    {/* Category Selector */}
                                    <div className="mb-3">
                                        <label className="text-xs font-bold text-slate-500 mb-1 block uppercase">Category</label>
                                        <select 
                                            value={newItemCategory} 
                                            onChange={e => setNewItemCategory(e.target.value)}
                                            className="w-full p-2 border rounded-lg text-sm bg-white outline-none"
                                        >
                                            {SERVICE_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                        </select>
                                    </div>

                                    <p className="text-xs font-bold text-slate-500 mb-2 uppercase">Set Prices per Duration (Optional)</p>
                                    {durations.length === 0 && <p className="text-xs text-red-400 italic">Add items to "Minutes" tab first to set prices.</p>}
                                    <div className="grid grid-cols-2 gap-2">
                                        {durations.map(d => (
                                            <div key={d.id} className="flex items-center gap-2 bg-white p-2 border rounded">
                                                <span className="text-xs font-bold text-slate-600 whitespace-nowrap w-16">{d.name}:</span>
                                                <input 
                                                    type="number"  
                                                    placeholder="Price"
                                                    className="w-full text-sm outline-none"
                                                    value={newItemPrices[d.name] || ''}
                                                    onChange={e => handlePriceChange(d.name, e.target.value, false)}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Commission Rate Input for Therapists */}
                            {activeTab === 'therapist' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <label className="text-xs font-bold text-slate-500 mb-2 uppercase block">Commission Rate (%)</label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        step="0.1"
                                        placeholder="e.g., 30 for 30%"
                                        className="w-full p-2 border rounded-lg text-sm outline-none"
                                        value={newItemCommission}
                                        onChange={e => setNewItemCommission(e.target.value)}
                                    />
                                </div>
                            )}
                            
                            {/* Discount Inputs */}
                            {activeTab === 'discount' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-1 block uppercase">Type</label>
                                            <select
                                                value={newDiscountType} 
                                                onChange={e => setNewDiscountType(e.target.value)}
                                                className="w-full p-2 border rounded-lg text-sm bg-white outline-none"
                                            >
                                                <option value="Percentage">Percentage (%)</option>
                                                <option value="Fixed">Fixed Amount (P)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-1 block uppercase">Value</label>
                                            <input
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                required
                                                placeholder={newDiscountType === 'Percentage' ? 'Max 100' : 'Amount'}
                                                className="w-full p-2 border rounded-lg text-sm outline-none"
                                                value={newDiscountValue}
                                                onChange={e => setNewDiscountValue(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    
                                    <label className="text-xs font-bold text-slate-500 mb-1 block uppercase">Barcode/Code (Optional)</label>
                                     <input 
                                        type="text" 
                                        placeholder="Enter discount code/barcode" 
                                        className="w-full p-2 border rounded-lg text-sm outline-none"
                                        value={newDiscountCode} 
                                        onChange={e => setNewDiscountCode(e.target.value)}
                                    />
                                </div>
                            )}


                            <button  
                                type="submit"  
                                disabled={isServiceAddDisabled}
                                className={`w-full text-white p-3 rounded-lg font-bold transition shadow-sm ${
                                    isServiceAddDisabled
                                        ? 'bg-slate-400 cursor-not-allowed'
                                        : 'bg-logo-green-600 hover:bg-logo-green-700'
                                }`}
                            >
                                Add to List
                            </button>
                        </form>
                    </div>

                    {/* Current List */}
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="p-4 bg-logo-green-50 font-bold text-logo-green-800 text-sm border-b border-logo-green-100 flex justify-between items-center">
                            <span>Current {activeTab === 'duration' ? 'Durations' : activeTab.charAt(0).toUpperCase() + activeTab.slice(1) + 's'} ({currentList.length})</span>
                            {icon}
                        </div>
                        
                        <div className="max-h-[400px] overflow-y-auto">
                            {currentList.length === 0 ? (
                                <p className="text-center text-slate-400 p-6 italic">No items found.</p>
                            ) : (
                                currentList.map(item => (
                                    <div key={item.id} className="p-4 border-b flex flex-col gap-2 last:border-b-0 hover:bg-slate-50">
                                            <div className="flex justify-between items-center w-full">
                                                {editingId === item.id ? (
                                                    <input 
                                                        value={editName}
                                                        onChange={e => setEditName(e.target.value)}
                                                        className="flex-1 p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-logo-green-500 mr-2"
                                                    />
                                                ) : (
                                                    <div className="flex flex-col">
                                                        <span className="text-slate-700 font-medium">{item.name}</span>
                                                        {/* Show Category in List */}
                                                        {activeTab === 'service' && item.category && (
                                                            <span className="text-[10px] text-slate-400 uppercase">{item.category}</span>
                                                        )}
                                                         {/* Show Discount Code and Type */}
                                                         {activeTab === 'discount' && (
                                                            <span className="text-[10px] text-slate-400">
                                                                Code: <span className="font-mono text-slate-600">{item.code || 'N/A'}</span> â€¢ {item.type} {item.type === 'Percentage' ? `${item.value}%` : `P${item.value}`}
                                                            </span>
                                                         )}
                                                    </div>
                                                )}
                                                
                                                <div className="flex gap-1">
                                                    {editingId === item.id ? (
                                                        <>
                                                            <button onClick={saveEdit} className="text-logo-green-600 hover:bg-logo-green-50 p-2 rounded transition"><Icons.CheckCircle2 size={18}/></button>
                                                            <button onClick={cancelEdit} className="text-slate-400 hover:bg-slate-100 p-2 rounded transition"><Icons.X size={18}/></button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <button onClick={() => startEdit(item)} className="text-slate-300 hover:text-blue-500 p-2 rounded hover:bg-blue-50 transition" title="Edit Item">
                                                                <Icons.Pencil size={16} />
                                                            </button>
                                                            <button type="button" onClick={() => onDelete(activeTab, item.id, item.name)} className="text-slate-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition" title="Delete Item">
                                                                <Icons.Trash2 size={16}/>
                                                            </button>
                                                        </>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Service Pricing Details */}
                                            {activeTab === 'service' && (
                                                <div className="text-xs text-slate-500 w-full">
                                                    {editingId === item.id ? (
                                                        <div className="grid grid-cols-2 gap-2 mt-2 bg-slate-100 p-2 rounded">
                                                            {durations.map(d => (
                                                                <div key={d.id} className="flex items-center gap-2">
                                                                    <span className="font-bold w-14">{d.name}:</span>
                                                                    <input  
                                                                        type="number"  
                                                                        className="w-full p-1 border rounded text-xs"
                                                                        placeholder="0"
                                                                        value={editPrices[d.name] || ''}
                                                                        onChange={e => handlePriceChange(d.name, e.target.value, true)}
                                                                    />
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="flex flex-wrap gap-2 mt-1">
                                                            {item.prices && Object.keys(item.prices).length > 0 ? (
                                                                Object.entries(item.prices).map(([dur, price]) => (
                                                                    <span key={dur} className="bg-logo-green-50 text-logo-green-700 px-2 py-0.5 rounded border border-logo-green-100">
                                                                        {dur}: <span className="font-bold">P{price}</span>
                                                                    </span>
                                                                ))
                                                            ) : (
                                                                <span className="italic text-slate-300">No specific prices set</span>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* Therapist Commission Details */}
                                            {activeTab === 'therapist' && (
                                                <div className="text-xs text-slate-500 w-full">
                                                    {editingId === item.id ? (
                                                        <div className="mt-2 bg-slate-100 p-2 rounded flex items-center gap-2">
                                                            <span className="font-bold w-20">Rate (%):</span>
                                                            <input  
                                                                type="number"  
                                                                min="0"
                                                                max="100"
                                                                step="0.1"
                                                                className="w-full p-1 border rounded text-xs"
                                                                placeholder="0"
                                                                value={editCommission}
                                                                onChange={e => setEditCommission(e.target.value)}
                                                            />
                                                        </div>
                                                    ) : (
                                                        <div className="flex flex-wrap gap-2 mt-1">
                                                            <span className="bg-teal-50 text-teal-700 px-2 py-0.5 rounded border border-teal-100 font-bold">
                                                                Commission: {item.commissionRate !== undefined ? `${item.commissionRate}%` : 'N/A'}
                                                            </span>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                    {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                </div>
            );
        };

        // --- Admin Reset User Modal ---
        const AdminResetUserModal = ({ editUserModal, setEditUserModal, handleResetPin, userRole }) => {
            if (!editUserModal.isOpen || !editUserModal.user) return null;

            const targetUser = editUserModal.user;
            const requiredLen = targetUser.role === 'admin' ? 6 : 4;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 fade-in">
                    <div className="bg-white rounded-xl p-6 w-full max-w-sm">
                        <h3 className="text-xl font-bold text-logo-green-800 mb-4 flex items-center gap-2">
                            <Icons.UserCog size={24}/> Reset Staff Credentials
                        </h3>

                        <div className="bg-slate-50 p-4 rounded-lg mb-4">
                            <p className="text-xs text-slate-500 uppercase font-bold">Staff Name:</p>
                            <p className="font-bold text-slate-800 text-lg mb-2">{targetUser.name}</p>

                            <p className="text-xs text-slate-500 uppercase font-bold">Username:</p>
                            <p className="font-mono text-logo-green-700 text-sm">@{targetUser.username}</p>
                        </div>

                        <form onSubmit={(e) => {
                            e.preventDefault();
                            handleResetPin(e);
                        }} className="space-y-4">
                            <label className="block">
                                <span className="text-sm font-semibold text-slate-700 block mb-1">Set New PIN ({requiredLen} Digits)</span>
                                <input
                                    required
                                    type="password"
                                    inputMode="numeric"
                                    maxLength={requiredLen}
                                    value={editUserModal.newPin}
                                    onChange={(e) => setEditUserModal({ ...editUserModal, newPin: e.target.value })}
                                    placeholder={`Enter new ${requiredLen}-digit PIN`}
                                    className="w-full p-3 border rounded-lg font-mono focus:ring-2 focus:ring-logo-green-500"
                                />
                            </label>

                            <div className="flex justify-end gap-2 pt-2">
                                <button  
                                    type="button"
                                    onClick={() => closeEditUserModal()}  
                                    className="px-4 py-2 text-slate-500 rounded hover:bg-slate-100"
                                >
                                    Cancel
                                </button>
                                <button  
                                    type="submit"  
                                    className="px-4 py-2 rounded text-white bg-logo-green-600 hover:bg-logo-green-700 font-bold"
                                >
                                    Reset PIN
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- ROOM MANAGEMENT COMPONENT ---
        const RoomManagement = ({ user, rooms, roomStatuses, onCheckInOut, getRoomBookingInfo }) => {
            const currentBranchRooms = useMemo(() => {
                if (user.currentBranch === 'ALL') return rooms;
                return rooms.filter(r => r.branch === user.currentBranch);
            }, [rooms, user.currentBranch]);

            return (
                <div className="space-y-6 fade-in">
                    <h2 className="text-lg font-bold text-logo-green-800 flex gap-2 items-center"><Icons.DoorOpen size={18} className="text-logo-green-700"/> Room Status Tracker ({user.currentBranch})</h2>
                    <p className="text-sm text-slate-500">Manage current client occupation status for spa rooms.</p>

                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        {currentBranchRooms.map(room => {
                            const status = roomStatuses[room.name] || { status: 'available' };
                            const isOccupied = status.status === 'occupied';
                            const info = getRoomBookingInfo(room.name);

                            return (
                                <div 
                                    key={room.id} 
                                    className={`p-4 rounded-xl shadow-lg border-l-4 ${
                                        isOccupied 
                                            ? 'bg-red-50 border-red-500' 
                                            : 'bg-logo-green-50 border-logo-green-500'
                                    } transition-shadow`}
                                >
                                    <h3 className="font-bold text-xl flex items-center gap-2">
                                        <Icons.DoorOpen size={20} className={isOccupied ? 'text-red-700' : 'text-logo-green-700'}/>
                                        {room.name}
                                    </h3>
                                    <p className={`text-xs font-bold uppercase mt-1 ${isOccupied ? 'text-red-600' : 'text-logo-green-600'}`}>
                                        {isOccupied ? 'OCCUPIED' : 'AVAILABLE'}
                                    </p>

                                    {isOccupied && info && (
                                        <div className="mt-3 text-xs space-y-1">
                                            <p className="text-slate-700 font-semibold">Client: {info.clientName}</p>
                                            <p className="text-slate-500">Therapist: {info.therapistName}</p>
                                            <p className="text-slate-500">Check In: {info.checkInTime}</p>
                                        </div>
                                    )}

                                    <div className="mt-4">
                                        <button
                                            onClick={() => onCheckInOut(room.name, isOccupied ? 'check_out' : 'check_in')}
                                            disabled={isOccupied && !info} // Can't check out if occupied but missing live booking data
                                            className={`w-full py-2 rounded-lg text-xs font-bold transition-colors ${
                                                isOccupied 
                                                    ? 'bg-red-500 text-white hover:bg-red-600 disabled:bg-red-200' 
                                                    : 'bg-logo-green-700 text-white hover:bg-logo-green-800'
                                            }`}
                                        >
                                            {isOccupied ? 'CHECK OUT' : 'CHECK IN'}
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };


        // --- MAIN APP ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbReady, setDbReady] = useState(false);
            const [configError, setConfigError] = useState(null);  
            const [isGlobalLoading, setIsGlobalLoading] = useState(false);  

            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [history, setHistory] = useState([]);
            
            const [dashboardDate, setDashboardDate] = useState(getTodayStr());

            // Offline Queue State
            const [offlineQueue, setOfflineQueue] = useState([]);
            
            // Real-time Listener Control State
            const [isTransactionListenerActive, setIsTransactionListenerActive] = useState(true);

            // Master Lists
            const [therapistsList, setTherapistsList] = useState([]);
            const [servicesList, setServicesList] = useState([]);
            const [durationsList, setDurationsList] = useState([]);
            const [driversList, setDriversList] = useState([]);  
            const [roomsList, setRoomsList] = useState([]); 
            const [discountsList, setDiscountsList] = useState([]); 

            // Room Status Tracking State
            const [roomStatuses, setRoomStatuses] = useState({});
            
            const [view, setView] = useState('dashboard');
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            
            // Staff Accountability State
            const [showMyShift, setShowMyShift] = useState(false);

            // History Filtering State
            const [historyStartDate, setHistoryStartDate] = useState('');
            const [historyEndDate, setHistoryEndDate] = useState('');
            
            // Forms
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPin, setLoginPin] = useState('');
            const [loginBranch, setLoginBranch] = useState('');  
            
            const [newUser, setNewUser] = useState({ name: '', username: '', pin: '', role: 'staff' });
            const [profileData, setProfileData] = useState({ username: '', pin: '' });
            
            // Forms related to new booking
            const [formData, setFormData] = useState({
                clientName: '',  
                clientContact: '',  
                type: 'booking',  
                time: new Date().toTimeString().slice(0, 5),
                targetBranch: '',
                notes: '',
                category: '',  
                bookingDate: getTodayStr(),  
                location: 'spa',  
                transportFee: '', 
                amount: '', 
                driver: '',
                room: '', // Deprecated global room, keeping for old logic safety
                paymentMethod: 'Cash' 
            });
            const [modal, setModal] = useState({
                isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red'
            });

            const [editUserModal, setEditUserModal] = useState({ isOpen: false, user: null, newPin: '' });

            const closeModal = () => setModal({ ...modal, isOpen: false });
            const closeEditUserModal = () => setEditUserModal({ isOpen: false, user: null, newPin: '' });
            
            // Multi-therapist/service state
            const [selectedTherapists, setSelectedTherapists] = useState([]);
            const [selectedDrivers, setSelectedDrivers] = useState([]);
            const [selectedRooms, setSelectedRooms] = useState([]); // NEW: Multi-room selection array
            const [therapistRows, setTherapistRows] = useState({}); 

            // NEW: Discount State for Booking/Sale
            const [selectedDiscountId, setSelectedDiscountId] = useState('');
            
            // --- Activity Timer for Throttling ---
            const activityTimerRef = useRef(null);
            const INACTIVITY_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes

            const resetActivityTimer = () => {
                if (activityTimerRef.current) {
                    clearTimeout(activityTimerRef.current);
                }
                activityTimerRef.current = setTimeout(() => {
                    if (isTransactionListenerActive) {
                        setIsTransactionListenerActive(false);
                        console.log("Activity Timeout: Pausing real-time listener.");
                    }
                }, INACTIVITY_TIMEOUT_MS);
                
                if (!isTransactionListenerActive) {
                    setIsTransactionListenerActive(true);
                    console.log("Activity Resumed: Restarting real-time listener.");
                }
            };
            
            // Listen for user activity events
            useEffect(() => {
                if (!user || view !== 'dashboard') return;

                const events = ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'];
                events.forEach(event => window.addEventListener(event, resetActivityTimer));
                resetActivityTimer(); 

                return () => {
                    if (activityTimerRef.current) {
                        clearTimeout(activityTimerRef.current);
                    }
                    events.forEach(event => window.removeEventListener(event, resetActivityTimer));
                };
            }, [user, view]);


            // --- 1. INITIALIZE FIREBASE & AUTH ---
            useEffect(() => {
                // Load offline queue
                const savedQueue = localStorage.getItem('spa_offline_queue');
                if (savedQueue) {
                    try {
                        setOfflineQueue(JSON.parse(savedQueue));
                    } catch (e) {
                        console.error("Failed to parse offline queue");
                    }
                }

                // Restore session
                const savedUser = localStorage.getItem('spa_user');
                if (savedUser) {
                    try {
                        setUser(JSON.parse(savedUser));
                    } catch (e) {
                        localStorage.removeItem('spa_user');
                    }
                }

                const initFirebase = async () => {
                    if (!firebaseConfig || !firebaseConfig.projectId) {
                        setConfigError("Firebase configuration is missing.");
                        return;
                    }
                    
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        
                        const auth = firebase.auth();
                        const db = firebase.firestore();

                        // Enable offline persistence
                        await db.enablePersistence().catch((err) => {
                            if (err.code === 'failed-precondition') {
                                console.log("Multiple tabs open, persistence disabled.");
                            } else if (err.code === 'unimplemented') {
                                console.log("Browser does not support persistence.");
                            }
                        });

                        await auth.signInAnonymously();

                        auth.onAuthStateChanged((u) => {
                            if (u) {
                                setFbUser(u);
                                setFb({ db, auth, appId: currentAppId });
                            }
                        });
                    } catch (error) {  
                        console.error("FB Init Error:", error);  
                        setConfigError(error.message);  
                    }
                };

                setTimeout(initFirebase, 500);

                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                return () => {
                    window.removeEventListener('online', () => setIsOnline(true));
                    window.removeEventListener('offline', () => setIsOnline(false));
                };
            }, []);

            // --- 1b. OFFLINE QUEUE PERSISTENCE & SYNC ---
            useEffect(() => {
                localStorage.setItem('spa_offline_queue', JSON.stringify(offlineQueue));
            }, [offlineQueue]);

            // Sync Logic
            useEffect(() => {
                const syncOfflineQueue = async () => {
                    if (isOnline && offlineQueue.length > 0 && fb) {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        const queueCopy = [...offlineQueue];
                        let syncedCount = 0;

                        setIsGlobalLoading(true);
                        try {
                            for (const item of queueCopy) {
                                const itemPayload = {
                                    ...item,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()  
                                };
                                delete itemPayload.localId;

                                await fb.db.collection(`${basePath}/transactions`).add(itemPayload);
                                syncedCount++;
                            }
                            
                            setOfflineQueue([]);
                            setModal({ isOpen: true, type: 'alert', title: 'Sync Complete', message: `Successfully uploaded ${syncedCount} offline records.`, confirmColor: 'logo-green', onConfirm: closeModal });

                        } catch (error) {
                            console.error("Sync failed", error);
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                };

                syncOfflineQueue();
            }, [isOnline, fb, offlineQueue.length]);

            // --- 2a. USER & AUTHENTICATION LISTENER (Always Active) ---
            useEffect(() => {
                if (!fb || !fbUser) return;
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                
                const getCollection = (name) => db.collection(`${basePath}/${name}`);

                // This listener is crucial for login/role management and must run constantly.
                const unsubUsers = getCollection('users')
                    .onSnapshot(async (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (data.length === 0) {
                            seedDefaultUsers(db, basePath);
                            return;  
                        }
                        const needsUpdate = data.filter(u => (u.username === 'admin' && u.pin.length < 20));
                        for (const u of needsUpdate) {
                             if (u.pin === '8888' || u.pin === '888888') {  
                                 const hashedPin = await hashPin('888888');  
                                 await getCollection('users').doc(u.id).update({ pin: hashedPin, role: 'admin' });  
                             }
                        }
                        setUsers(data);
                    }, (error) => console.error("Sync Error: Users", error));

                return () => {  
                    unsubUsers();  
                };
            }, [fb, fbUser]);


            // --- 2b. TRANSACTION LISTENER (Dashboard Only) ---
            useEffect(() => {
                // Only run when on dashboard and authenticated
                if (!fb || !fbUser || view !== 'dashboard') return () => {};
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                const getCollection = (name) => db.collection(`${basePath}/${name}`);
                
                let unsubTrans = () => {};
                if (isTransactionListenerActive) {
                    let query = getCollection('transactions');
                    if (dashboardDate) {
                        query = query.where('bookingDate', '==', dashboardDate);
                    }
                    
                    unsubTrans = query.onSnapshot((snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            data.sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp));
                            setTransactions(data);
                            setDbReady(true);
                        }, (error) => console.error("Sync Error: Transactions", error));
                }

                return () => {  
                    unsubTrans();
                };
            }, [fb, fbUser, isTransactionListenerActive, view, dashboardDate]);  

            
            // --- 2c. MASTER DATA LISTENER (Lists/Add/Expense/Rooms/Team Views Only) ---
            // Listener only runs when these views are active to save reads.
            useEffect(() => {
                const activeViews = ['add', 'expense', 'lists', 'team', 'rooms'];
                if (!fb || !fbUser || !activeViews.includes(view)) {
                    // Clear data when listener is not active to save memory/prevent stale data
                    setTherapistsList([]);
                    setServicesList([]);
                    setDurationsList([]);
                    setDriversList([]);
                    setRoomsList([]);
                    setDiscountsList([]);
                    setRoomStatuses({});
                    return () => {};
                }
                
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                const getCollection = (name) => db.collection(`${basePath}/${name}`);

                const unsubTherapists = getCollection('therapists')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTherapistsList(data.sort((a, b) => a.name.localeCompare(b.name)));
                    });

                const unsubServices = getCollection('services')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setServicesList(data.sort((a, b) => a.name.localeCompare(b.name)));
                    });

                const unsubDurations = getCollection('durations')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDurationsList(data.sort((a, b) => {
                            const valA = parseInt(a.name) || 0;
                            const valB = parseInt(b.name) || 0;
                            return valA - valB;
                        }));
                    });

                const unsubDrivers = getCollection('drivers')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDriversList(data.sort((a, b) => a.name.localeCompare(b.name)));
                    }, (error) => console.error("Sync Error: Drivers", error));

                const unsubRooms = getCollection('rooms')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setRoomsList(data.sort((a, b) => {
                            const valA = parseInt(a.name);
                            const valB = parseInt(b.name);
                            if (!isNaN(valA) && !isNaN(valB)) return valA - valB;
                            return a.name.localeCompare(b.name);
                        }));
                    }, (error) => console.error("Sync Error: Rooms", error));
                    
                const unsubDiscounts = getCollection('discounts')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDiscountsList(data.sort((a, b) => a.name.localeCompare(b.name)));
                    }, (error) => console.error("Sync Error: Discounts", error));

                // NEW: Room Status Listener
                const unsubRoomStatuses = getCollection('roomStatuses')
                    .onSnapshot((snapshot) => {
                        const statuses = {};
                        snapshot.forEach(doc => {
                            statuses[doc.id] = { id: doc.id, ...doc.data() };
                        });
                        setRoomStatuses(statuses);
                    }, (error) => console.error("Sync Error: Room Statuses", error));
                
                return () => {  
                    unsubTherapists();  
                    unsubServices();
                    unsubDurations();
                    unsubDrivers();
                    unsubRooms(); 
                    unsubDiscounts(); 
                    unsubRoomStatuses();
                };
            }, [fb, fbUser, view]);  


            // --- 2d. HISTORY LISTENER (History View Only) ---
            useEffect(() => {
                if (!fb || !fbUser || view !== 'history') {
                    if (history.length > 0) setHistory([]);  
                    return () => {};
                }
                
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                let query = db.collection(`${basePath}/history`).orderBy('timestamp_val', 'desc');
                
                const unsub = query.limit(50)
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        data.sort((a, b) => getMillis(b.timestamp_val) - getMillis(a.timestamp_val));
                        setHistory(data);
                    }, (error) => {
                        console.error("Sync Error: History", error);
                    });

                return () => unsub();
            }, [fb, fbUser, view]);  

            // --- 2e. REAL-TIME USER ROLE SYNC (depends on 2a) ---
            useEffect(() => {
                if (user && users.length > 0) {
                    const freshData = users.find(u => u.id === user.id);
                    if (freshData) {
                        if (freshData.role !== user.role || freshData.name !== user.name || freshData.username !== user.username) {
                            const updatedUser = { ...freshData, currentBranch: user.currentBranch };
                            setUser(updatedUser);
                            localStorage.setItem('spa_user', JSON.stringify(updatedUser));
                        }
                    }
                }
            }, [users, user]);
            
            // --- 2f. REMOVED: PRESENCE SYSTEM (To reduce writes) ---

            const isUserOnline = (lastActive) => {
                if (!lastActive) return false;
                const diff = Date.now() - getMillis(lastActive);
                return diff < 2 * 60 * 1000;
            };


            // --- 3. HELPERS ---
            
            // Helper to Group Services by Category
            const groupedServices = useMemo(() => {
                const groups = {};
                // Initialize groups based on constants to ensure order
                SERVICE_CATEGORIES.forEach(cat => groups[cat] = []);
                
                servicesList.forEach(s => {
                    const cat = s.category || 'Others'; 
                    if (SERVICE_CATEGORIES.includes(cat)) {
                        groups[cat].push(s);
                    } else {
                        // Fallback for custom categories, add them under 'Others' or dynamically create? Let's use 'Others'
                        if (groups['Others']) groups['Others'].push(s);
                        else groups[cat] = [s];
                    }
                });
                // Sort categories by index of constant array to maintain order, and then add any residual categories
                const sortedGroups = SERVICE_CATEGORIES.reduce((acc, cat) => {
                    if (groups[cat] && groups[cat].length > 0) {
                        acc[cat] = groups[cat];
                    }
                    return acc;
                }, {});
                
                // Add any non-standard categories if they somehow exist, though they should be mapped to 'Others' by logic above
                Object.keys(groups).filter(cat => !SERVICE_CATEGORIES.includes(cat)).forEach(cat => {
                     sortedGroups[cat] = groups[cat];
                });

                return sortedGroups;
            }, [servicesList]);

            const seedDefaultUsers = async (db, basePath) => {
                const defaults = [
                    { name: 'Owner Admin', username: 'admin', pin: '888888', role: 'admin' },  
                    { name: 'Morning Rec.', username: 'morning', pin: '1111', role: 'staff' },  
                    { name: 'Night Rec.', username: 'night', pin: '2222', role: 'staff' }  
                ];
                const userColl = db.collection(`${basePath}/users`);
                const usersToSeed = await Promise.all(defaults.map(async u => {
                    const hashedPin = await hashPin(u.pin);
                    return { ...u, pin: hashedPin };  
                }));
                for (const u of usersToSeed) await userColl.add(u);
            };

            useEffect(() => {
                if (view === 'profile' && user) {
                    const freshUser = users.find(u => u.id === user.id) || user;
                    setProfileData({ username: freshUser.username, pin: '' });  
                }
            }, [view, user, users]);

            useEffect(() => {
                if (user && formData.targetBranch === '' && user.currentBranch !== 'ALL') {
                    setFormData(prev => ({ ...prev, targetBranch: user.currentBranch }));
                }
            }, [user]);

            const formatCurrency = (val) => {
                if (val === undefined || val === null || val === '') return '';
                const isNegative = val < 0;
                // Use PH locale for PHP currency display
                const formatted = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Math.abs(val));
                return isNegative ? `(${formatted})` : formatted;
            };
            
            const formatDate = (timestamp) => {
                const millis = getMillis(timestamp);
                if (!millis) return 'N/A';
                const date = new Date(millis);
                return date.toLocaleDateString();
            };
            
            // Filter Transactions
            const getFilteredData = () => {
                if (!user) return [];
                let data = transactions;

                if (user.currentBranch !== 'ALL') {
                    data = data.filter(t => t.branch === user.currentBranch);
                }

                if (showMyShift && user.role !== 'admin') {  
                    data = data.filter(t => t.recordedBy === user.name);
                }
                
                // Dashboard filter is already applied via Firestore listener in useEffect 2b.
                // This local filter is only necessary if the listener is paused/date changed.
                if (view === 'dashboard' && dashboardDate) {
                    data = data.filter(t => {
                        let recordDateStr = '';
                        if (t.bookingDate) {
                            recordDateStr = t.bookingDate;  
                        } else {
                            // Fallback to timestamp date if bookingDate is missing (older records)
                            const d = new Date(getMillis(t.timestamp));
                            recordDateStr = d.toISOString().split('T')[0];
                        }
                        return recordDateStr === dashboardDate;
                    });
                }
                
                return data;
            };

            const filteredTransactions = getFilteredData();

            const stats = useMemo(() => {
                const data = filteredTransactions;
                const completedRevenue = data.filter(t => t.status === 'completed' && t.type !== 'expense').reduce((acc, curr) => acc + Number(curr.amount), 0);
                const totalExpenses = data.filter(t => t.type === 'expense').reduce((acc, curr) => acc + Math.abs(Number(curr.amount)), 0);
                const pendingValue = data.filter(t => t.status === 'pending' && t.type !== 'expense').reduce((acc, curr) => acc + Number(curr.amount), 0);
                const totalBookings = data.filter(t => t.type === 'booking').length;
                const completedSales = data.filter(t => t.status === 'completed').length;
                const netCash = completedRevenue - totalExpenses;

                return {  
                    totalRevenue: completedRevenue,  
                    pendingValue,  
                    totalBookings,  
                    completedSales,
                    totalExpenses,  
                    netCash  
                };
            }, [filteredTransactions]);

            const branchFinancials = useMemo(() => {
                if (user?.currentBranch !== 'ALL' || user.role !== 'admin') return null;  

                const grouped = {};
                const branchesToAnalyze = [...BRANCHES, 'Unknown'];

                branchesToAnalyze.forEach(branch => {
                    grouped[branch] = {
                        totalRevenue: 0,
                        totalExpenses: 0,
                        netCash: 0,
                        count: 0
                    };
                });

                filteredTransactions.forEach(t => {
                    const branch = t.branch || 'Unknown';
                    const amount = Number(t.amount);
                    
                    if (!grouped[branch]) {
                        grouped[branch] = { totalRevenue: 0, totalExpenses: 0, netCash: 0, count: 0 };
                    }

                    grouped[branch].count++;
                    
                    if (t.type !== 'expense' && t.status === 'completed') {
                        grouped[branch].totalRevenue += amount;
                        grouped[branch].netCash += amount;
                    } else if (t.type === 'expense') {
                        grouped[branch].totalExpenses += Math.abs(amount);
                        grouped[branch].netCash += amount;  
                    }
                });

                return Object.entries(grouped)
                    .filter(([branch, data]) => data.count > 0 || BRANCHES.includes(branch))
                    .map(([branch, data]) => ({ branch, ...data }))
                    .sort((a, b) => {
                        const indexA = BRANCHES.indexOf(a.branch);
                        const indexB = BRANCHES.indexOf(b.branch);
                        if (indexA === -1) return 1;  
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });

            }, [user?.currentBranch, user?.role, filteredTransactions]);

            const therapistStats = useMemo(() => {
                const grouped = {};
                // Only consider completed bookings/sales for commission calculation
                const commissionableTransactions = filteredTransactions.filter(t => t.type !== 'expense' && t.status === 'completed');

                commissionableTransactions.forEach(t => {
                    const branch = t.branch || (user.currentBranch !== 'ALL' ? user.currentBranch : 'Unknown');
                    const name = t.therapist ? t.therapist.trim() : 'Unassigned';
                    
                    if (!name || name === 'Unassigned') return;

                    const therapist = therapistsList.find(th => th.name === name);
                    // Default to 0 commission rate if not found in list
                    const rate = therapist?.commissionRate || 0;  

                    if (!grouped[branch]) grouped[branch] = {};
                    if (!grouped[branch][name]) grouped[branch][name] = { name, count: 0, amount: 0, commission: 0, rate };
                    
                    const amount = Number(t.amount);
                    let commissionableAmount = amount;
                    
                    // Subtract the *split* transport fee from the revenue before calculating commission, if applicable
                    if (t.transportFee) {
                        commissionableAmount = amount - Number(t.transportFee);
                    }
                    
                    if (commissionableAmount < 0) commissionableAmount = 0; // Prevent negative commission base

                    grouped[branch][name].count++;
                    grouped[branch][name].amount += commissionableAmount;
                    grouped[branch][name].commission += commissionableAmount * (rate / 100);
                });

                const result = {};
                Object.keys(grouped).forEach(branch => {
                    result[branch] = Object.values(grouped[branch]).sort((a, b) => b.count - a.count);
                });
                
                return result;
            }, [filteredTransactions, user, therapistsList]);
            
            const filteredHistory = useMemo(() => {
                let data = history;

                if (user && user.currentBranch !== 'ALL') {
                    data = data.filter(h => h.branch === user.currentBranch);
                }

                if (historyStartDate) {
                    const startTimestamp = new Date(historyStartDate).getTime();
                    data = data.filter(h => getMillis(h.timestamp_val) >= startTimestamp);
                }

                if (historyEndDate) {
                    const endTimestamp = new Date(historyEndDate);
                    endTimestamp.setDate(endTimestamp.getDate() + 1);  
                    const endTimestampVal = endTimestamp.getTime();
                    data = data.filter(h => getMillis(h.timestamp_val) < endTimestampVal);
                }

                return data;
            }, [history, historyStartDate, historyEndDate, user]);

            // Helper to get booking info for room management display
            const getRoomBookingInfo = (roomName) => {
                const status = roomStatuses[roomName];
                if (status && status.status === 'occupied') {
                    // Find the original transaction that checked this room in
                    const bookingId = status.bookingId;
                    const transaction = transactions.find(t => t.id === bookingId);
                    
                    return {
                        clientName: transaction?.clientName || status.clientName || 'N/A',
                        therapistName: transaction?.therapist || status.therapistName || 'N/A',
                        checkInTime: status.checkInTime ? new Date(getMillis(status.checkInTime)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'N/A',
                        bookingId: bookingId
                    };
                }
                return null;
            }

            // Helper to calculate price based on service/duration (used in form logic)
            const calculatePrice = (serviceName, durationName, transport = 0) => {
                let basePrice = 0;
                
                if (serviceName) {
                    const foundService = servicesList.find(s => s.name === serviceName);
                    if (foundService) {
                        if (durationName && foundService.prices && foundService.prices[durationName]) {
                            basePrice = foundService.prices[durationName];
                        } 
                        else if (foundService.price) {
                            basePrice = foundService.price;
                        }
                    }
                }
                
                // Return only the base price without transport here, as transport is added separately in totalEstimatedPrice
                return basePrice;
            };

            // Helper to handle transport fee change
            const handleTransportChange = (val) => {
                const transport = parseFloat(val) || 0;
                setFormData(prev => ({ ...prev, transportFee: val }));
                // Note: Total estimated price recalculation relies on the useMemo hook, not an immediate update here
            };

            // Helper for expense amount change
            const handleExpenseAmountChange = (e) => {
                setFormData(prev => ({ ...prev, amount: e.target.value }));
            };

            // --- 4. ACTIONS ---

            // Helper to handle adding/removing therapists
            const toggleTherapistSelection = (name) => {
                if (selectedTherapists.includes(name)) {
                    // Remove
                    setSelectedTherapists(prev => prev.filter(t => t !== name));
                    setTherapistRows(prev => {
                        const copy = { ...prev };
                        delete copy[name];
                        return copy;
                    });
                } else {
                    // Add
                    setSelectedTherapists(prev => [...prev, name]);
                    // Initialize this therapist's row with the first available duration/service combination 
                    // or default to empty strings if lists are unavailable.
                    const defaultDurationName = durationsList[0]?.name || '';
                    const defaultServiceName = servicesList[0]?.name || '';
                    const basePrice = calculatePrice(defaultServiceName, defaultDurationName, 0); 
                    setTherapistRows(prev => ({
                        ...prev,
                        [name]: {
                            service: defaultServiceName,
                            duration: defaultDurationName,  
                            amount: basePrice 
                        }
                    }));
                }
            };

            // NEW: Toggle Room Selection
            const toggleRoomSelection = (roomName) => {
                const currentStatus = roomStatuses[roomName]?.status;
                const roomAvailable = currentStatus !== 'occupied';

                setSelectedRooms(prev => {
                    const isSelected = prev.includes(roomName);
                    
                    if (isSelected) {
                         // Allow unselecting regardless of status
                        return prev.filter(r => r !== roomName);
                    } else {
                        // Only allow selecting if available
                        if (roomAvailable) {
                            return [...prev, roomName];
                        } else {
                            // Room is occupied and not currently selected
                            setModal({ isOpen: true, type: 'alert', title: 'Room Occupied', message: `Room ${roomName} is currently occupied and unavailable for new selection.`, confirmColor: 'red', onConfirm: closeModal });
                            return prev;
                        }
                    }
                });
            };
            
            // Helper to apply discount calculation
            const getAppliedDiscountValue = (totalServicePrice) => {
                if (!selectedDiscountId || totalServicePrice <= 0) return 0;
                
                const discount = discountsList.find(d => d.id === selectedDiscountId);
                if (!discount || !discount.value || discount.value <= 0) return 0;
                
                if (discount.type === 'Percentage') {
                    const rate = Math.min(100, discount.value) / 100;
                    return totalServicePrice * rate;
                } else if (discount.type === 'Fixed') {
                    return Math.min(totalServicePrice, discount.value);
                }
                return 0;
            };

            // Helper to handle adding/removing drivers
            const toggleDriverSelection = (name) => {
                if (selectedDrivers.includes(name)) {
                    setSelectedDrivers(prev => prev.filter(d => d !== name));
                } else {
                    setSelectedDrivers(prev => [...prev, name]);
                }
            };

            // Helper to update specific therapist row
            const updateTherapistRow = (name, field, value) => {
                setTherapistRows(prev => {
                    const currentRow = prev[name] || {};
                    const updatedRow = { ...currentRow, [field]: value };
                    
                    // Recalculate price if service or duration changes
                    if (field === 'service' || field === 'duration') {
                        const sName = field === 'service' ? value : (updatedRow.service || '');
                        const dName = field === 'duration' ? value : (updatedRow.duration || '');
                        
                        // Recalculate based on newly defined calculatePrice
                        updatedRow.amount = calculatePrice(sName, dName, 0);
                    }

                    return { ...prev, [name]: updatedRow };
                });
            };

            // ADDED: Logic for room and driver listType (includes new discount logic)
            const handleAddItem = async (listType, itemName, extraData = null) => {
                const trimmedItemName = itemName.trim();
                if (!trimmedItemName) return;

                const basePath = `artifacts/${fb.appId}/public/data`;
                let collectionName = '';
                let checkList = [];
                const data = { name: trimmedItemName, branch: user.currentBranch }; // Ensure new items are tagged with branch

                if (listType === 'therapist') {
                    collectionName = 'therapists';
                    checkList = therapistsList;
                    if (extraData) Object.assign(data, extraData);
                } else if (listType === 'service') {
                    collectionName = 'services';
                    checkList = servicesList;
                    if (extraData) {
                        data.prices = extraData.prices || {};
                        data.category = extraData.category || 'Others';
                    }  
                } else if (listType === 'duration') {
                    collectionName = 'durations';
                    checkList = durationsList;
                } else if (listType === 'driver') {
                    collectionName = 'drivers';
                    checkList = driversList;
                } else if (listType === 'room') { 
                    collectionName = 'rooms';
                    checkList = roomsList;
                } else if (listType === 'discount') { // NEW
                    collectionName = 'discounts';
                    checkList = discountsList;
                    if (extraData) {
                         Object.assign(data, extraData);
                    }
                    if (data.code && checkList.some(item => item.code && item.code.toLowerCase() === data.code.toLowerCase())) {
                        setModal({ isOpen: true, type: 'alert', title: 'Duplicate Code', message: `The code "${data.code}" is already in use.`, onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                } else {
                    return;
                }
                
                if (checkList.some(item => item.name.toLowerCase() === trimmedItemName.toLowerCase())) {
                    setModal({ isOpen: true, type: 'alert', title: 'Duplicate Item', message: `${trimmedItemName} already exists in ${listType}s.`, onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }

                setIsGlobalLoading(true);
                try {
                    const docRef = await fb.db.collection(`${basePath}/${collectionName}`).add(data);

                    // If a room is added, create its initial status record
                    if (listType === 'room') {
                        await fb.db.collection(`${basePath}/roomStatuses`).doc(trimmedItemName).set({
                            status: 'available',
                            branch: user.currentBranch,
                            roomName: trimmedItemName,
                            roomId: docRef.id
                        });
                    }
                } catch (err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to add item.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            // NEW: Room Check-in/Check-out logic
            const handleRoomCheckInOut = async (roomName, action) => {
                const basePath = `artifacts/${fb.appId}/public/data`;
                const roomStatusRef = fb.db.collection(`${basePath}/roomStatuses`).doc(roomName);
                
                if (action === 'check_in') {
                    // Filter completed in-spa transactions for today that are not yet assigned to this room
                    const candidateTransactions = filteredTransactions.filter(t => 
                        t.bookingDate === getTodayStr() && 
                        t.status === 'completed' && 
                        t.location === 'spa' &&
                        (!t.room || t.room.split(', ').every(r => r !== roomName)) // Booking does not have this room assigned
                    ).sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp)); 

                    const transaction = candidateTransactions.find(t => true); // Take the latest eligible one

                    if (!transaction) {
                        setModal({ isOpen: true, type: 'alert', title: 'No Booking to Check In', message: `No completed in-spa booking found today that can be linked to Room ${roomName}.`, confirmColor: 'red', onConfirm: closeModal });
                        return;
                    }

                    const currentStatus = roomStatuses[roomName]?.status;
                    if (currentStatus === 'occupied') {
                        setModal({ isOpen: true, type: 'alert', title: 'Room Occupied', message: `Room ${roomName} is already checked in.`, confirmColor: 'red', onConfirm: closeModal });
                        return;
                    }

                    setIsGlobalLoading(true);
                    try {
                        // 1. Update Room Status
                        await roomStatusRef.set({
                            status: 'occupied',
                            bookingId: transaction.id, 
                            clientName: transaction.clientName,
                            therapistName: transaction.therapist,
                            checkInTime: firebase.firestore.FieldValue.serverTimestamp(),
                            branch: user.currentBranch,
                            roomName: roomName
                        });
                        
                        // 2. Update Transaction (Assign the room to the existing booking record)
                        const currentRoomList = transaction.room ? transaction.room.split(', ').filter(r => r.trim() !== '') : [];
                        const updatedRoomList = [...new Set([...currentRoomList, roomName])].join(', ');

                        await fb.db.collection(`${basePath}/transactions`).doc(transaction.id).update({
                            room: updatedRoomList
                        });

                        setModal({ isOpen: true, type: 'alert', title: 'Checked In!', message: `Client ${transaction.clientName} checked into Room ${roomName}.`, confirmColor: 'logo-green', onConfirm: closeModal });

                    } catch (error) {
                        console.error("Check-in failed:", error);
                        setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to check in room.', confirmColor: 'red', onConfirm: closeModal });
                    } finally {
                        setIsGlobalLoading(false);
                    }

                } else if (action === 'check_out') {
                    setModal({
                        isOpen: true,
                        type: 'confirm',
                        title: 'Confirm Check Out',
                        message: `Are you sure you want to check out Room ${roomName}?`,
                        confirmColor: 'red',
                        onConfirm: async () => {
                            closeModal();
                            setIsGlobalLoading(true);
                            try {
                                // 1. Reset Room Status
                                await roomStatusRef.update({
                                    status: 'available',
                                    bookingId: firebase.firestore.FieldValue.delete(),
                                    clientName: firebase.firestore.FieldValue.delete(),
                                    therapistName: firebase.firestore.FieldValue.delete(),
                                    checkInTime: firebase.firestore.FieldValue.delete(),
                                });

                                // NOTE: We leave the room assigned to the transaction record for historical integrity.

                                setModal({ isOpen: true, type: 'alert', title: 'Checked Out!', message: `Room ${roomName} is now available.`, confirmColor: 'logo-green', onConfirm: closeModal });
                            } catch (error) {
                                console.error("Check-out failed:", error);
                                setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to check out room.', confirmColor: 'red', onConfirm: closeModal });
                            } finally {
                                setIsGlobalLoading(false);
                            }
                        }
                    });
                }
            };


            const handleDeleteItem = (listType, id, name) => {
                let collectionName = '';
                if (listType === 'therapist') collectionName = 'therapists';
                else if (listType === 'service') collectionName = 'services';
                else if (listType === 'duration') collectionName = 'durations';
                else if (listType === 'driver') collectionName = 'drivers';  
                else if (listType === 'discount') collectionName = 'discounts'; // NEW
                else if (listType === 'room') collectionName = 'rooms'; 
                else return;

                const basePath = `artifacts/${fb.appId}/public/data`;
                
                setModal({
                    isOpen: true, type: 'confirm', title: `Delete ${listType}?`, message: `Are you sure you want to permanently delete "${name}"?`, confirmColor: 'red',
                    onConfirm: async () => {
                        closeModal();  
                        setIsGlobalLoading(true);
                        try {
                            await fb.db.collection(`${basePath}/${collectionName}`).doc(id).delete();
                            
                            // If a room is deleted, delete its status too
                            if (listType === 'room') {
                                await fb.db.collection(`${basePath}/roomStatuses`).doc(name).delete().catch(err => console.warn("Failed to delete corresponding roomStatus:", err));
                            }

                        } catch (error) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Deletion failed.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            const handleEditItem = async (listType, id, updatedData) => {
                let collectionName = '';
                let checkList = [];  
                if (listType === 'therapist') {
                    collectionName = 'therapists';
                    checkList = therapistsList;
                }
                else if (listType === 'service') {
                    collectionName = 'services';
                    checkList = servicesList;
                }
                else if (listType === 'duration') {
                    collectionName = 'durations';
                    checkList = durationsList;
                }
                else if (listType === 'driver') {
                    collectionName = 'drivers';
                    checkList = driversList;
                }
                else if (listType === 'room') { 
                    collectionName = 'rooms';
                    checkList = roomsList;
                }
                else if (listType === 'discount') { // NEW
                    collectionName = 'discounts';
                    checkList = discountsList;
                    if (updatedData.code && checkList.some(item => item.code && item.code.toLowerCase() === updatedData.code.toLowerCase() && item.id !== id)) {
                        setModal({ isOpen: true, type: 'alert', title: 'Duplicate Code', message: `The code "${updatedData.code}" is already in use.`, onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                }
                else return;

                if (updatedData.name) {
                    const oldItem = checkList.find(i => i.id === id);
                    const newName = updatedData.name.trim().toLowerCase();
                    const isDuplicate = checkList.some(item =>  
                        item.name.toLowerCase() === newName && item.id !== id
                    );
                    
                    if (isDuplicate) {
                        setModal({ isOpen: true, type: 'alert', title: 'Duplicate Name', message: `The name "${updatedData.name}" is already in use by another ${listType}.`, onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                    updatedData.name = newName.charAt(0).toUpperCase() + newName.slice(1);  
                }

                const basePath = `artifacts/${fb.appId}/public/data`;
                setIsGlobalLoading(true);
                try {
                    await fb.db.collection(`${basePath}/${collectionName}`).doc(id).update(updatedData);
                    setModal({ isOpen: true, type: 'alert', title: 'Success', message: 'Item updated successfully.', onConfirm: closeModal, confirmColor: 'logo-green' });
                } catch (error) {
                    console.error("Update error:", error);
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update item.', onConfirm: closeModal, confirmColor: 'red' });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                
                const newPin = profileData.pin;
                const newUsername = profileData.username.trim();
                const updateData = { username: newUsername };

                setIsGlobalLoading(true);
                try {
                    if (newPin && newPin.length > 0) {
                        const requiredLen = user.role === 'admin' ? 6 : 4;  
                        
                        if (newPin.length !== requiredLen) {
                             setModal({ isOpen: true, type: 'alert', title: 'Policy Check', message: `Your PIN must be exactly ${requiredLen} digits.`, onConfirm: closeModal, confirmColor: 'red' });
                             return;
                        }

                        const hashedPin = await hashPin(newPin);
                        if (!hashedPin) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'New PIN hashing failed. Check PIN length.', onConfirm: closeModal, confirmColor: 'red' });
                            return;
                        }
                        updateData.pin = hashedPin;
                    }

                    if (users.some(u => u.username.toLowerCase() === newUsername.toLowerCase() && u.id !== user.id)) {  
                        setModal({ isOpen: true, type: 'alert', title: 'Username Taken', message: 'This username is already in use by another staff.', onConfirm: closeModal, confirmColor: 'red' });
                        return;  
                    }
                    
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    await fb.db.collection(`${basePath}/users`).doc(user.id).update(updateData);
                    
                    const updatedUser = { ...user, ...updateData };
                    setUser(updatedUser);
                    localStorage.setItem('spa_user', JSON.stringify(updatedUser));  
                    setModal({ isOpen: true, type: 'alert', title: 'Updated', message: 'Credentials synced.', onConfirm: closeModal, confirmColor: 'logo-green' });
                } catch (err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update profile.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const handleSubmit = async (e, typeOverride = null) => {
                e.preventDefault();
                const transactionType = typeOverride || formData.type;
                const transactionBranch = user.currentBranch === 'ALL' ? formData.targetBranch : user.currentBranch;

                if (!transactionBranch || (user.currentBranch === 'ALL' && !formData.targetBranch)) {
                    setModal({ isOpen: true, type: 'alert', title: 'Missing Branch', message: 'Please select a Target Branch.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }

                if (transactionType === 'expense') {
                    const expenseAmount = parseFloat(formData.amount);
                    if (isNaN(expenseAmount) || expenseAmount <= 0) {
                        setModal({ isOpen: true, type: 'alert', title: 'Invalid Amount', message: 'Expense amount must be a positive number.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                    if (!formData.category || !formData.notes) {
                            setModal({ isOpen: true, type: 'alert', title: 'Missing Information', message: 'Please provide Category, and Description (Notes) for the expense.', onConfirm: closeModal, confirmColor: 'red' });
                            return;
                    }

                } else {
                    // Booking/Sale Validation
                    if (!formData.clientName) {
                            setModal({ isOpen: true, type: 'alert', title: 'Missing Information', message: 'Please enter a Client Name.', onConfirm: closeModal, confirmColor: 'red' });
                            return;
                    }

                    if (selectedTherapists.length === 0) {
                            setModal({ isOpen: true, type: 'alert', title: 'Missing Therapist', message: 'Please add at least one Therapist.', onConfirm: closeModal, confirmColor: 'red' });
                            return;
                    }
                    
                    // CRITICAL VALIDATION: Check Room Selection for In-Spa Service
                    if (formData.location === 'spa' && selectedRooms.length === 0) {
                        setModal({ isOpen: true, type: 'alert', title: 'Missing Room', message: 'Please select at least one Room for In-Spa service.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }

                    // Validate individual rows and calculate total base price
                    let totalServicePrice = 0;
                    for (const name of selectedTherapists) {
                        const row = therapistRows[name];
                        const rowPrice = parseFloat(row?.amount) || 0;
                        if (!row || !row.service || !row.duration || rowPrice <= 0) {
                            setModal({ isOpen: true, type: 'alert', title: 'Missing Details', message: `Please ensure Service, Duration, and a valid Price (P>0) are set for therapist ${name}.`, onConfirm: closeModal, confirmColor: 'red' });
                            return;
                        }
                        totalServicePrice += rowPrice;
                    }
                    
                    if (totalServicePrice <= 0) {
                        setModal({ isOpen: true, type: 'alert', title: 'Invalid Total', message: 'The total service amount must be greater than P0.00.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }

                    // Conflict Check (Loop through all selected therapists)
                    const allBookings = [...transactions, ...offlineQueue];
                    const conflict = selectedTherapists.find(thName => {
                        return allBookings.some(t =>  
                            t.therapist === thName &&  
                            t.time === formData.time &&
                            (t.bookingDate || formatDate(t.timestamp)) === formData.bookingDate &&  
                            t.type !== 'expense'
                        );
                    });

                    if (conflict) {
                        setModal({ isOpen: true, type: 'alert', title: 'Booking Conflict', message: `Therapist ${conflict} is already booked at ${formData.time} on ${formData.bookingDate}.`, onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                }
                
                // --- DISCOUNT CALCULATION ---
                const totalServicePrice = selectedTherapists.reduce((acc, name) => acc + (parseFloat(therapistRows[name]?.amount) || 0), 0);
                const discountAmount = getAppliedDiscountValue(totalServicePrice);
                const appliedDiscountData = discountsList.find(d => d.id === selectedDiscountId);
                const discountName = appliedDiscountData ? appliedDiscountData.name : null;
                
                // If a discount is applied, calculate the effective discount rate to split the discount proportionally
                const effectiveDiscountRate = totalServicePrice > 0 ? (discountAmount / totalServicePrice) : 0;

                // --- TRANSACTION PREPARATION ---
                const transactionsToSave = [];
                
                if (transactionType === 'expense') {
                    transactionsToSave.push({
                        clientName: formData.category,  
                        description: formData.notes,  
                        category: formData.category,  
                        amount: -Math.abs(parseFloat(formData.amount)), // Use formData.amount for expense
                        type: transactionType,
                        status: 'completed',
                        time: formData.time,
                        bookingDate: formData.bookingDate,  
                        recordedBy: user.name,
                        branch: transactionBranch,
                        notes: formData.notes.trim(),
                        location: formData.location || 'spa',
                        paymentMethod: formData.paymentMethod
                    });
                } else {
                    // Booking/Sale Logic
                    const totalTransport = parseFloat(formData.transportFee) || 0;
                    const splitTransport = selectedTherapists.length > 0 ? (totalTransport / selectedTherapists.length) : 0;
                    
                    const driverString = selectedDrivers.length > 0 ? selectedDrivers.join(', ') : '';
                    const roomString = selectedRooms.length > 0 ? selectedRooms.join(', ') : ''; // NEW: Multi-room string

                    selectedTherapists.forEach(thName => {
                        const row = therapistRows[thName];
                        
                        const rowServicePrice = parseFloat(row.amount) || 0;
                        
                        // Apply proportional discount to the service price only
                        const discountedServicePrice = rowServicePrice * (1 - effectiveDiscountRate);
                        
                        // Final amount saved = discounted service price + split transport fee
                        const finalRowAmount = discountedServicePrice + splitTransport;

                        // Calculate the proportional discount amount for this specific row
                        const proportionalDiscountAmount = rowServicePrice * effectiveDiscountRate;


                        transactionsToSave.push({
                            clientName: formData.clientName,  
                            clientContact: formData.clientContact,  
                            description: formData.notes,  
                            service: row.service,  
                            therapist: thName,
                            amount: finalRowAmount,  
                            duration: row.duration,  
                            type: transactionType,
                            status: transactionType === 'sale' ? 'completed' : 'pending',
                            time: formData.time,
                            bookingDate: formData.bookingDate,  
                            recordedBy: user.name,
                            branch: transactionBranch,
                            notes: formData.notes.trim(),
                            location: formData.location || 'spa',
                            transportFee: splitTransport, 
                            driver: formData.location === 'home' ? driverString : '',
                            room: formData.location === 'spa' ? roomString : '', // Use multi-room string
                            paymentMethod: formData.paymentMethod, 
                            
                            discountName: discountName, 
                            discountAmount: proportionalDiscountAmount, 
                        });
                    });
                }

                // --- SAVE / SYNC LOGIC ---

                if (!isOnline) {
                    const offlineItems = transactionsToSave.map(t => ({
                        ...t,
                        localId: Date.now() + Math.random(),  
                        timestamp: Date.now()  
                    }));
                    
                    setOfflineQueue(prev => [...prev, ...offlineItems]);
                    
                    resetForm(transactionBranch);
                    setModal({ isOpen: true, type: 'alert', title: 'Saved Offline', message: `${transactionsToSave.length} records queued. They will sync automatically when online.`, confirmColor: 'orange', onConfirm: closeModal });
                    return;
                }

                setIsGlobalLoading(true);
                try {
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    
                    const promises = transactionsToSave.map(t => fb.db.collection(`${basePath}/transactions`).add({
                        ...t,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }));
                    
                    await Promise.all(promises);

                    resetForm(transactionBranch);
                    
                    setModal({ isOpen: true, type: 'alert', title: 'Saved!', message: `${transactionsToSave.length} record(s) saved for ${transactionBranch}.`, confirmColor: 'logo-green', onConfirm: closeModal });

                    setDashboardDate(formData.bookingDate); 
                    setView('dashboard');
                } catch (error) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to save. Check connection.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const resetForm = (branch) => {
                const resetTargetBranch = user.currentBranch === 'ALL' ? branch : user.currentBranch;
                setFormData({  
                    clientName: '', 
                    clientContact: '', 
                    type: 'booking', 
                    time: new Date().toTimeString().slice(0, 5),
                    targetBranch: resetTargetBranch, 
                    notes: '', 
                    category: '',
                    bookingDate: new Date().toISOString().split('T')[0],
                    location: 'spa', 
                    transportFee: '', 
                    amount: '', // Reset expense amount
                    driver: '', 
                    room: '',
                    paymentMethod: 'Cash' 
                });
                setSelectedTherapists([]); 
                setSelectedDrivers([]); 
                setSelectedRooms([]); // Reset multi-room selection
                setTherapistRows({}); 
                setSelectedDiscountId(''); // Reset discount
            };

            const toggleStatus = async (t) => {
                if (t.type === 'expense') return;  

                const basePath = `artifacts/${fb.appId}/public/data`;
                const newStatus = t.status === 'pending' ? 'completed' : 'pending';
                setIsGlobalLoading(true);
                try {
                    await fb.db.collection(`${basePath}/transactions`).doc(t.id).update({ status: newStatus });
                } catch(err) {
                    console.error("Status toggle failed");
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const requestDelete = (id) => {
                if (user?.role !== 'admin') return;  

                setModal({
                    isOpen: true, type: 'confirm', title: 'Delete Record?', message: 'Permanently remove from cloud?', confirmColor: 'red',
                    onConfirm: async () => {
                        closeModal();
                        setIsGlobalLoading(true);
                        try {
                            const basePath = `artifacts/${fb.appId}/public/data`;
                            await fb.db.collection(`${basePath}/transactions`).doc(id).delete();
                        } catch(err) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Delete failed.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            const requestEndDay = () => {
                if (user?.currentBranch === 'ALL' || (user?.role !== 'admin' && user?.role !== 'staff')) {  
                    setModal({ isOpen: true, type: 'alert', title: 'Access Denied', message: 'Only authorized Staff/Admin can close the shift/day on a specific branch view.', onConfirm: closeModal, confirmColor: 'red' });  
                    return;
                }
                
                if (filteredTransactions.length === 0) {
                    setModal({ isOpen: true, type: 'alert', title: 'No Data', message: 'Nothing to save for this branch on this date.', onConfirm: closeModal, confirmColor: 'logo-green' });
                    return;
                }

                const isToday = dashboardDate === new Date().toISOString().split('T')[0];
                const msg = isToday ? "Archive Today's Records?" : `Archive Records for ${dashboardDate}?`;

                setModal({
                    isOpen: true, type: 'confirm', title: 'End Day / Shift', message: `${msg} This will permanently save and clear active records for ${user.currentBranch} on this specific date.`, confirmColor: 'logo-green',
                    onConfirm: async () => {
                        closeModal();
                        setIsGlobalLoading(true);
                        
                        let historySaveSuccess = false;
                        
                        try {
                            const basePath = `artifacts/${fb.appId}/public/data`;
                            const historyColl = fb.db.collection(`${basePath}/history`);
                            const transColl = fb.db.collection(`${basePath}/transactions`);

                            await historyColl.add({
                                date: dashboardDate,  
                                date_formatted: new Date(dashboardDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                timestamp_val: firebase.firestore.FieldValue.serverTimestamp(),
                                transactions: filteredTransactions,
                                stats: stats,
                                therapist_stats: therapistStats,  
                                branch: user.currentBranch,
                                closedBy: user.name
                            });
                            historySaveSuccess = true;
                            
                            const deletePromises = filteredTransactions.map(t => transColl.doc(t.id).delete());
                            await Promise.all(deletePromises);

                            setView('dashboard');  
                            setDashboardDate(getTodayStr()); // Reset view date to today after archiving
                            setModal({ isOpen: true, type: 'alert', title: 'Shift Closed!', message: `Shift transactions successfully archived.`, confirmColor: 'logo-green', onConfirm: closeModal });

                        } catch (error) {
                            console.error("End Day Fatal Error:", error);
                            let title = 'End Day Failed';
                            let message = 'An error occurred during the closing process. Your data has been preserved in the Live Records. Please check your connection or contact support.';

                            if (historySaveSuccess) {
                                title = 'Cleanup Failed';
                                message = 'The shift report was successfully saved to History, but clearing the dashboard failed. Live Records may contain entries that need manual deletion (Admin only).';
                            }
                            
                            setModal({ isOpen: true, type: 'alert', title: title, message: message, confirmColor: 'red', onConfirm: closeModal });
                            
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            const handleAddUser = async (e) => {
                e.preventDefault();
                const trimmedUsername = newUser.username.trim();
                const trimmedName = newUser.name.trim();
                
                if (!trimmedName || !trimmedUsername || !newUser.pin) return;
                
                setIsGlobalLoading(true);
                try {
                    const hashedPin = await hashPin(newUser.pin);
                    if (!hashedPin) {
                        setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'PIN hashing failed. Check PIN length (min 4).', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                    
                    const requiredLen = newUser.role === 'admin' ? 6 : 4;
                    if (newUser.pin.length !== requiredLen) {  
                        setModal({ isOpen: true, type: 'alert', title: 'Policy Check', message: `${newUser.role.toUpperCase()} PINs must be exactly ${requiredLen} digits.`, onConfirm: closeModal, confirmColor: 'red' });  
                        return;
                    }

                    if (users.some(u => u.username.toLowerCase() === trimmedUsername.toLowerCase())) {  
                        setModal({ isOpen: true, type: 'alert', title: 'Username Taken', message: 'This username is already in use.', onConfirm: closeModal, confirmColor: 'red' });
                        return;  
                    }
                    
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    const newUserPayload = {  
                        ...newUser,  
                        name: trimmedName,
                        username: trimmedUsername,
                        pin: hashedPin  
                    };
                    
                    if (user.currentBranch !== 'ALL') {
                        newUserPayload.currentBranch = user.currentBranch;
                    }

                    await fb.db.collection(`${basePath}/users`).add(newUserPayload);
                    setNewUser({ name: '', username: '', pin: '', role: 'staff' });  
                } catch(err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to add user.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const handleDeleteUser = (id) => {
                if (users.length <= 1) {  
                    setModal({ isOpen: true, type: 'alert', title: 'Action Denied', message: 'Cannot delete the last remaining user.', onConfirm: closeModal, confirmColor: 'red' });
                    return;  
                }
                setModal({ isOpen: true, type: 'confirm', title: 'Remove Staff?', message: 'Revoke access for this user?', confirmColor: 'red', onConfirm: async () => {  
                    closeModal();
                    setIsGlobalLoading(true);
                    try {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        await fb.db.collection(`${basePath}/users`).doc(id).delete();  
                    } catch(err) {
                        setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to delete user.', confirmColor: 'red', onConfirm: closeModal });
                    } finally {
                        setIsGlobalLoading(false);
                    }
                }});
            };

            const handleToggleRole = (targetUser) => {
                const newRole = targetUser.role === 'admin' ? 'staff' : 'admin';  
                const action = newRole === 'admin' ? 'Promote to Admin' : 'Demote to Staff';  
                
                setModal({
                    isOpen: true,
                    type: 'confirm',
                    title: action,
                    message: `Are you sure you want to change ${targetUser.name}'s role to ${newRole.toUpperCase()}? Note: This does not affect their PIN length policy until they reset it.`,
                    confirmColor: 'logo-green',
                    onConfirm: async () => {
                        closeModal();
                        setIsGlobalLoading(true);
                        try {
                            const basePath = `artifacts/${fb.appId}/public/data`;
                            await fb.db.collection(`${basePath}/users`).doc(targetUser.id).update({ role: newRole });
                        } catch (error) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update role.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                
                const newPin = profileData.pin;
                const newUsername = profileData.username.trim();
                const updateData = { username: newUsername };

                setIsGlobalLoading(true);
                try {
                    if (newPin && newPin.length > 0) {
                        const requiredLen = user.role === 'admin' ? 6 : 4;  
                        
                        if (newPin.length !== requiredLen) {
                             setModal({ isOpen: true, type: 'alert', title: 'Policy Check', message: `Your PIN must be exactly ${requiredLen} digits.`, onConfirm: closeModal, confirmColor: 'red' });
                             return;
                        }

                        const hashedPin = await hashPin(newPin);
                        if (!hashedPin) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'New PIN hashing failed. Check PIN length.', onConfirm: closeModal, confirmColor: 'red' });
                            return;
                        }
                        updateData.pin = hashedPin;
                    }

                    if (users.some(u => u.username.toLowerCase() === newUsername.toLowerCase() && u.id !== user.id)) {  
                        setModal({ isOpen: true, type: 'alert', title: 'Username Taken', message: 'This username is already in use by another staff.', onConfirm: closeModal, confirmColor: 'red' });
                        return;  
                    }
                    
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    await fb.db.collection(`${basePath}/users`).doc(user.id).update(updateData);
                    
                    const updatedUser = { ...user, ...updateData };
                    setUser(updatedUser);
                    localStorage.setItem('spa_user', JSON.stringify(updatedUser));  
                    setModal({ isOpen: true, type: 'alert', title: 'Updated', message: 'Credentials synced.', onConfirm: closeModal, confirmColor: 'logo-green' });
                } catch (err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update profile.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };
            
            const handleResetPin = async (e) => {
                e.preventDefault();
                const targetUser = editUserModal.user;
                const newPin = editUserModal.newPin;

                const requiredLen = targetUser.role === 'admin' ? 6 : 4;

                if (newPin.length !== requiredLen) {
                    setModal({ isOpen: true, type: 'alert', title: 'PIN Error', message: `${targetUser.role.toUpperCase()} PIN must be exactly ${requiredLen} digits.`, onConfirm: closeModal, confirmColor: 'red' });  
                    return;
                }
                
                setIsGlobalLoading(true);
                try {
                    const hashedPin = await hashPin(newPin);
                    if (!hashedPin) {
                        setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'PIN hashing failed.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }

                    const basePath = `artifacts/${fb.appId}/public/data`;
                    await fb.db.collection(`${basePath}/users`).doc(targetUser.id).update({ pin: hashedPin });
                    
                    setEditUserModal({ isOpen: false, user: null, newPin: '' });
                    setModal({ isOpen: true, type: 'alert', title: 'Success', message: `${targetUser.name}'s PIN has been reset.`, onConfirm: closeModal, confirmColor: 'logo-green' });
                } catch (error) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update PIN: ' + error.message, onConfirm: closeModal, confirmColor: 'red' });
                } finally {
                    setIsGlobalLoading(false);
                }
            };
            
            const handleReconnect = () => {
                if (!isTransactionListenerActive) {
                    setIsTransactionListenerActive(true);
                    resetActivityTimer();
                }
            };
            
            // Calculate Total Estimated Price for display in the form
            const totalEstimatedPrice = useMemo(() => {
                const totalServicePrice = selectedTherapists.reduce((acc, name) => acc + (parseFloat(therapistRows[name]?.amount) || 0), 0);
                const totalTransportFee = parseFloat(formData.transportFee) || 0;
                
                const discountValue = getAppliedDiscountValue(totalServicePrice);

                return (totalServicePrice - discountValue) + totalTransportFee;
            }, [selectedTherapists, therapistRows, formData.transportFee, selectedDiscountId, discountsList]);
            
            // --- RENDER ---

            if (configError) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-100 text-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-md">
                        <Icons.Cloud size={48} className="mx-auto text-slate-400 mb-4"/>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">Setup Failed</h2>
                        <p className="text-slate-500 text-sm mb-6 font-mono bg-slate-50 p-2 rounded border text-left text-xs">{configError}</p>
                        <p className="text-xs text-slate-400">
                            Check the console for detailed Firebase connection errors.
                        </p>
                    </div>
                </div>
            );

            if (!dbReady && fb) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50"><div className="loader mb-4"></div><p className="text-slate-400 text-sm">Connecting to Spa Cloud...</p></div>;

            // LOGIN SCREEN
            if (!user) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 fade-in relative">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-logo-green-100 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-logo-green-700 to-teal-600"></div>
                            
                            <h1 className="text-3xl font-extrabold text-logo-green-900 mb-1">AHMAS System</h1>
                            <p className="text-slate-500 mb-6 text-sm">Staff Portal</p>
                            
                            <form onSubmit={handleLoginSubmit} className="space-y-4">
                                <div className="relative">
                                    <Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" />
                                    <select required value={loginBranch} onChange={(e)=>setLoginBranch(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white appearance-none text-slate-600">
                                            <option value="" disabled>Select Branch Location</option>
                                            {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                            <option value="ALL" className="font-bold text-logo-green-700">ALL BRANCHES (Owner View)</option>
                                    </select>
                                    <Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/>
                                </div>
                                <div className="relative"><Icons.User size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required value={loginUsername} onChange={(e)=>setLoginUsername(e.target.value)} placeholder="Username" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white" /></div>
                                <div className="relative"><Icons.Fingerprint size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required type="password" inputMode="numeric" value={loginPin} onChange={(e)=>setLoginPin(e.target.value)} placeholder="PIN" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white" /></div>
                                <button className="w-full bg-logo-green-700 text-white font-bold py-3 rounded-xl hover:bg-logo-green-600 transition-all shadow-lg shadow-logo-green-200 mt-2">Login</button>
                            </form>
                            {!isOnline && <p className="mt-4 text-xs text-red-400 flex items-center justify-center gap-1"><Icons.WifiOff size={12}/> You are offline</p>}
                        </div>
                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                        {isGlobalLoading && <LoadingOverlay message="Verifying..." />}
                    </div>
                );
            }

            // DASHBOARD
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-24 relative fade-in">
                    <header className="bg-white border-b border-logo-green-100 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <h1 className="text-xl font-extrabold text-logo-green-800 leading-tight">AHMAS System</h1>
                                <div>
                                    <div className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-wide text-slate-500">
                                            <span className="bg-logo-green-100 text-logo-green-700 px-2 py-0.5 rounded flex items-center gap-1"><Icons.MapPin size={10}/> {user.currentBranch}</span>
                                            <span className="flex items-center gap-1"><Icons.UserCircle2 size={10}/> {user.name}</span>
                                            {offlineQueue.length > 0 && (
                                                <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded flex items-center gap-1 animate-pulse">
                                                    <Icons.WifiOff size={10}/> {offlineQueue.length} Pending
                                                </span>
                                            )}
                                    </div>
                                </div>
                            </div>
                            <button onClick={()=>{
                                setUser(null);
                                localStorage.removeItem('spa_user');
                                setView('dashboard');
                            }} className="p-2 text-slate-400 hover:text-red-500 rounded-lg"><Icons.LogOut size={20}/></button>
                        </div>
                        {!isOnline && <div className="bg-red-500 text-white text-xs text-center py-1">No Internet - Sync Paused</div>}
                    </header>

                    <main className="max-w-3xl mx-auto px-4 py-6">
                        <div className="flex p-1 bg-slate-200/60 rounded-xl mb-6 sticky top-[70px] z-10 backdrop-blur-sm overflow-x-auto">
                            <button onClick={()=>setView('dashboard')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='dashboard'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.LayoutDashboard size={16}/> Daily</button>
                            <button onClick={()=>setView('add')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='add'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.Plus size={16}/> Booking</button>
                            <button onClick={()=>setView('expense')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='expense'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.MinusCircle size={16}/> Expense</button>
                            {user.currentBranch !== 'ALL' && <button onClick={()=>setView('rooms')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='rooms'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.DoorOpen size={16}/> Rooms</button>}

                            <button onClick={()=>setView('profile')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='profile'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.UserCog size={16}/> Profile</button>
                            {user.role === 'admin' && <button onClick={()=>setView('lists')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='lists'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.ShieldCheck size={16}/> Lists</button>}
                            
                            <button onClick={()=>setView('history')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='history'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.History size={16}/> History</button>
                            
                            {user.role === 'admin' && (
                                <button onClick={()=>setView('team')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='team'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'} relative`}>
                                    <Icons.Users size={16}/> Team
                                    {/* Removed real-time online count to save reads */}
                                </button>
                            )}
                        </div>

                        {view === 'dashboard' && (
                            <div className="space-y-6 fade-in">
                                
                                {/* DATE SELECTOR - NAVIGATION */}
                                <div className="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                                    <button onClick={() => {
                                        const d = new Date(dashboardDate);
                                        d.setDate(d.getDate() - 1);
                                        setDashboardDate(d.toISOString().split('T')[0]);
                                    }} className="p-2 text-slate-400 hover:text-logo-green-600"><Icons.ChevronDown className="rotate-90" size={20}/></button>
                                    
                                    <div className="text-center">
                                        <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wide block">Viewing Date</label>
                                        <input 
                                            type="date" 
                                            value={dashboardDate} 
                                            onChange={(e) => setDashboardDate(e.target.value)} 
                                            className="font-bold text-lg text-slate-700 bg-transparent text-center focus:outline-none cursor-pointer"
                                        />
                                        {dashboardDate > getTodayStr() && (
                                            <span className="block text-[10px] text-blue-500 font-bold bg-blue-50 rounded-full px-2 py-0.5 mt-1">FUTURE BOOKINGS</span>
                                        )}
                                        {dashboardDate === getTodayStr() && (
                                            <span className="block text-[10px] text-green-500 font-bold bg-green-50 rounded-full px-2 py-0.5 mt-1">LIVE / TODAY</span>
                                        )}
                                    </div>

                                    <button onClick={() => {
                                        const d = new Date(dashboardDate);
                                        d.setDate(d.getDate() + 1);
                                        setDashboardDate(d.toISOString().split('T')[0]);
                                    }} className="p-2 text-slate-400 hover:text-logo-green-600"><Icons.ChevronDown className="-rotate-90" size={20}/></button>
                                </div>

                                {/* NEW: ALL BRANCH SUMMARY (Owner Admin only) */}
                                {user.currentBranch === 'ALL' && user.role === 'admin' && branchFinancials && branchFinancials.length > 0 && (  
                                    <div className="bg-white p-4 rounded-xl shadow-lg border border-teal-100 space-y-4">
                                        <h3 className="text-sm font-bold text-teal-700 uppercase tracking-wider flex items-center gap-2"><Icons.TrendingUp size={16}/> All Branch Summary</h3>
                                        <div className="grid grid-cols-2 gap-3 mb-4 border-b pb-3 border-slate-100">
                                            <div className="bg-logo-green-50 p-3 rounded-lg"><p className="text-xs font-medium text-logo-green-700 uppercase">Combined Revenue</p><p className="text-lg font-bold text-logo-green-900">{formatCurrency(stats.totalRevenue)}</p></div>
                                            <div className="bg-red-50 p-3 rounded-lg"><p className="text-xs font-medium text-red-700 uppercase">Total Expenses</p><p className="text-lg font-bold text-red-900">{formatCurrency(stats.totalExpenses)}</p></div>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full text-xs text-left">
                                                <thead className="text-slate-500 uppercase bg-slate-50">
                                                    <tr>
                                                        <th className="px-2 py-2">Branch</th>
                                                        <th className="px-2 py-2 text-right">Net Cash</th>
                                                        <th className="px-2 py-2 text-right text-red-600">Expenses</th>
                                                        <th className="px-2 py-2 text-right">Trans.</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {branchFinancials.map((b) => (
                                                        <tr key={b.branch} className="border-b hover:bg-teal-50/50 transition">
                                                            <td className="px-2 py-2 font-semibold text-slate-700">{b.branch}</td>
                                                            <td className={`px-2 py-2 text-right font-bold ${b.netCash < 0 ? 'text-red-600' : 'text-logo-green-700'}`}>{formatCurrency(b.netCash)}</td>
                                                            <td className="px-2 py-2 text-right text-red-500">{formatCurrency(b.totalExpenses)}</td>
                                                            <td className="px-2 py-2 text-right text-slate-500">{b.count}</td>
                                                        </tr>
                                                    ))}
                                                    <tr className="bg-logo-green-100 font-extrabold text-sm text-logo-green-900 border-t-2 border-logo-green-700">
                                                        <td className="px-2 py-2">GRAND TOTAL</td>
                                                        <td className={`px-2 py-2 text-right ${stats.netCash < 0 ? 'text-red-600 font-bold' : ''}`}>{formatCurrency(stats.netCash)}</td>
                                                        <td className="px-2 py-2 text-right text-red-600">{formatCurrency(stats.totalExpenses)}</td>
                                                        <td className="px-2 py-2 text-right">{transactions.length}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                                {/* END ALL BRANCH SUMMARY */}


                                {/* STANDARD STATS (Will reflect ALL or single branch based on user selection) */}
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100"><p className="text-slate-500 text-xs font-medium uppercase">Sales (Completed)</p><h3 className="text-xl font-bold text-slate-800 mt-1">{formatCurrency(stats.totalRevenue)}</h3></div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100"><p className="text-slate-500 text-xs font-medium uppercase">Expenses</p><h3 className="text-xl font-bold text-slate-800 mt-1 text-red-600">{formatCurrency(stats.totalExpenses)}</h3></div>
                                    <div className={`bg-white p-4 rounded-xl shadow-sm border border-logo-green-100 border-l-[3px] ${stats.netCash < 0 ? 'border-red-500' : 'border-logo-green-500'}`}>
                                        <p className="text-slate-500 text-xs font-medium uppercase flex items-center gap-1"><Icons.Wallet size={12}/> Net Cash</p>
                                        <h3 className={`text-xl font-bold mt-1 ${stats.netCash < 0 ? 'text-red-600' : 'text-logo-green-700'}`}>{formatCurrency(stats.netCash)}</h3>
                                    </div>
                                </div>

                                <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2"><Icons.Trophy size={16} className="text-logo-green-700"/> Payroll Estimate ({user.currentBranch})</h3>
                                    
                                    {Object.keys(therapistStats).length === 0 ? (
                                        <p className="text-sm text-slate-400 italic text-center py-2">No completed activity yet.</p>
                                    ) : (
                                        Object.keys(therapistStats).sort((a, b) => {
                                               const idxA = BRANCHES.indexOf(a);
                                               const idxB = BRANCHES.indexOf(b);
                                               if (idxA === -1 && idxB === -1) return a.localeCompare(b);
                                               if (idxA === -1) return 1;
                                               if (idxB === -1) return -1;
                                               return idxA - idxB;
                                            }).map(branch => (
                                                <div key={branch} className="mb-4 last:mb-0">
                                                    {(user.currentBranch === 'ALL' || Object.keys(therapistStats).length > 1) && (
                                                        <h4 className="text-[10px] font-bold text-logo-green-700 uppercase mb-2 bg-logo-green-50 px-2 py-1 rounded inline-block">
                                                            {branch}
                                                        </h4>
                                                    )}
                                                    <div className="space-y-2">
                                                        {therapistStats[branch].map((s) => (
                                                            <div key={s.name} className="flex justify-between items-center pb-2 border-b border-slate-50 last:border-0 last:pb-0 ml-1">
                                                                <div className="flex gap-2 items-center">
                                                                    <span className="w-6 h-6 bg-logo-green-100 text-logo-green-700 rounded-full flex items-center justify-center text-[10px] font-bold">{s.name.charAt(0)}</span>
                                                                    <span className="text-sm font-semibold text-slate-700">{s.name}</span>
                                                                </div>
                                                                <div className="text-right flex flex-col">
                                                                    <span className="text-sm font-bold text-logo-green-700 flex items-center gap-1">
                                                                        <Icons.TrendingUp size={12} className="text-teal-600"/> {formatCurrency(s.commission)}  
                                                                    </span>
                                                                    <span className="text-[9px] text-slate-400">({s.rate}% of {formatCurrency(s.amount)})</span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))
                                    )}
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-lg font-bold text-logo-green-900 flex gap-2 items-center">
                                            <Icons.LayoutDashboard size={18}/> 
                                            {dashboardDate === getTodayStr() ? "Live Records" : "Future Bookings"} 
                                            <span className="text-xs font-normal text-slate-500 ml-2">({showMyShift ? 'My Shift' : user.currentBranch})</span>
                                        </h2>
                                        <div className="flex items-center gap-2">
                                            {/* Show "My Shift" toggle for staff */}
                                            {user.role === 'staff' && (  
                                                <button  
                                                    onClick={() => setShowMyShift(!showMyShift)}
                                                    className={`text-[10px] font-bold ${showMyShift ? 'bg-logo-green-700 text-white' : 'bg-logo-green-50 text-logo-green-700'} px-3 py-1.5 rounded-full border border-logo-green-200 flex gap-1 items-center transition-colors`}
                                                >
                                                    <Icons.User size={12}/> {showMyShift ? 'Showing My Shift' : 'Show Only Mine'}
                                                </button>
                                            )}
                                            {/* 'End Day' button is visible if the user is in a specific branch (Admin or Staff) */}
                                            {user.currentBranch !== 'ALL' && dashboardDate <= getTodayStr() && (
                                                <button onClick={requestEndDay} className="text-[10px] font-bold text-logo-green-700 bg-logo-green-50 px-3 py-1.5 rounded-full border border-logo-green-200 flex gap-1"><Icons.Archive size={12}/> End Day</button>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Throttling/Reconnection Alert */}
                                    {!isTransactionListenerActive && (
                                        <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-4 text-sm flex justify-between items-center rounded-r shadow-sm">
                                            <span><span className="font-bold">Updates Paused:</span> Real-time dashboard synchronization has paused due to inactivity to conserve Firebase reads.</span>
                                            <button onClick={handleReconnect} className="underline font-bold hover:text-orange-900 ml-2 whitespace-nowrap flex items-center gap-1">
                                                <Icons.Loader2 size={12} className="animate-spin text-orange-500"/> Reconnect
                                            </button>
                                        </div>
                                    )}

                                    {/* Performance Alert */}
                                    {filteredTransactions.length > 50 && (
                                        <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-4 text-sm flex justify-between items-center rounded-r shadow-sm">
                                            <span><span className="font-bold">Performance Alert:</span> You have {filteredTransactions.length} active records. End the day to archive and speed up the app.</span>
                                            {user.currentBranch !== 'ALL' && dashboardDate <= getTodayStr() && <button onClick={requestEndDay} className="underline font-bold hover:text-orange-900 ml-2 whitespace-nowrap">End Day Now</button>}
                                        </div>
                                    )}

                                    {filteredTransactions.length===0?<div className="text-center py-12 border border-dashed rounded-xl text-slate-400 text-sm">No records found for the current filter.</div>:
                                    <div className="space-y-3">
                                            {filteredTransactions.map(t=>(
                                                <div key={t.id} className={`bg-white p-4 rounded-xl border-l-[6px] flex justify-between items-start ${
                                                    t.type === 'expense' ? 'border-l-red-500' : (t.status==='completed'?'border-l-logo-green-500':'border-l-orange-400')
                                                } shadow-sm`}>
                                                    <div className="flex-1 pr-4">
                                                        <div className="flex gap-2 mb-1 items-center flex-wrap">
                                                            <span className="text-[10px] font-bold bg-slate-100 px-2 rounded text-slate-500">{t.branch}</span>
                                                            <span className="text-xs font-mono text-slate-400">{t.bookingDate || formatDate(t.timestamp)} - {t.time}</span>
                                                            {/* Home Service Badge */}
                                                            {t.location === 'home' && (
                                                                <span className="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded flex items-center gap-1">
                                                                    <Icons.Car size={10}/> Home {t.driver && <span className="font-normal text-blue-600">via {t.driver}</span>}
                                                                </span>
                                                            )}
                                                            {/* Room Badge */}
                                                            {t.location !== 'home' && t.room && (
                                                                <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded flex items-center gap-1 border border-slate-200">
                                                                    <Icons.DoorOpen size={10}/> Rm: {t.room}
                                                                </span>
                                                            )}
                                                        </div>
                                                        
                                                        <h3 className={`font-bold ${t.type === 'expense' ? 'text-red-700' : 'text-slate-800'}`}>
                                                            {t.type === 'expense' ? `Expense: ${t.category}` : t.clientName}
                                                            {t.clientContact && t.type !== 'expense' && <span className="text-xs font-normal text-slate-500 ml-2"><Icons.User size={10} className="inline"/> {t.clientContact}</span>}
                                                        </h3>
                                                        
                                                        <div className="text-xs text-slate-500 mt-1 flex gap-2 flex-wrap items-center">
                                                            {t.type === 'expense' ? (
                                                                <span>{t.notes}</span>
                                                            ) : (
                                                                <>
                                                                    <span>{t.service}</span>
                                                                    {t.duration && <span> â€¢ {t.duration}</span>}
                                                                    <span> â€¢ {t.therapist}</span>
                                                                    {t.discountName && ( // NEW: Discount name display
                                                                        <span className="ml-1 flex items-center gap-1 px-1.5 py-0.5 rounded border text-[9px] font-bold uppercase bg-orange-100 text-orange-600 border-orange-200">
                                                                            <Icons.Tag size={8}/> {t.discountName} (-{formatCurrency(t.discountAmount)})
                                                                        </span>
                                                                    )}
                                                                    {/* Payment Method Badge */}
                                                                    {t.paymentMethod && (
                                                                        <span className={`ml-1 flex items-center gap-1 px-1.5 py-0.5 rounded border text-[9px] font-bold uppercase ${
                                                                            t.paymentMethod === 'GCash' ? 'bg-blue-50 text-blue-600 border-blue-200' :
                                                                            t.paymentMethod === 'Maya' ? 'bg-zinc-100 text-zinc-700 border-zinc-300' :
                                                                            t.paymentMethod === 'BPI' ? 'bg-red-50 text-red-600 border-red-200' :
                                                                            t.paymentMethod === 'Eastwest Bank' ? 'bg-amber-50 text-amber-600 border-amber-200' :
                                                                            t.paymentMethod === 'Card' ? 'bg-purple-50 text-purple-600 border-purple-200' :
                                                                            'bg-emerald-50 text-emerald-600 border-emerald-200'
                                                                        }`}>
                                                                            {t.paymentMethod === 'GCash' && <Icons.Smartphone size={8} />}
                                                                            {t.paymentMethod === 'Maya' && <Icons.Smartphone size={8} />}
                                                                            {(t.paymentMethod === 'BPI' || t.paymentMethod === 'Eastwest Bank') && <Icons.Landmark size={8} />}
                                                                            {t.paymentMethod === 'Card' && <Icons.CreditCard size={8} />}
                                                                            {t.paymentMethod === 'Cash' && <Icons.Banknote size={8} />}
                                                                            {t.paymentMethod}
                                                                        </span>
                                                                    )}
                                                                </>
                                                            )}
                                                        </div>
                                                        
                                                        {t.notes && t.notes.trim() && t.type !== 'expense' && (
                                                            <div className="mt-2 text-xs bg-slate-50 p-2 rounded border border-slate-200 text-slate-700 flex items-start gap-1">
                                                                <Icons.ClipboardList size={14} className="min-w-[14px] text-logo-green-700 mt-[2px]"/>
                                                                <span className="font-medium">Notes: </span>
                                                                <span className="italic">{t.notes}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="text-right min-w-[80px]">
                                                        <div className={`font-bold text-lg ${t.type === 'expense' ? 'text-red-600' : (t.status==='completed'?'text-logo-green-700':'text-orange-600')}`}>{formatCurrency(t.amount)}</div>
                                                        
                                                        {t.transportFee && Number(t.transportFee) > 0 && (
                                                            <div className="text-[10px] text-slate-400">
                                                                (Inc. {formatCurrency(t.transportFee)} Trans.)
                                                            </div>
                                                        )}

                                                        <div className="flex justify-end gap-2 mt-1">
                                                            {t.type !== 'expense' && (
                                                                <button onClick={()=>toggleStatus(t)} className={`p-1.5 rounded-full ${t.status==='completed'?'bg-logo-green-100 text-logo-green-700':'bg-orange-100 text-orange-600'}`}>
                                                                    {t.status==='completed'?<Icons.CheckCircle2 size={16}/>:<Icons.DollarSign size={16}/>}
                                                                </button>
                                                            )}
                                                            {user.role==='admin'&&<button onClick={()=>requestDelete(t.id)} className="p-1.5 text-slate-300 hover:text-red-500"><Icons.Trash2 size={16}/></button>}  
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                    </div>}
                                </div>
                            </div>
                        )}

                        {view === 'rooms' && user.currentBranch !== 'ALL' && (
                            <RoomManagement 
                                user={user}
                                rooms={roomsList}
                                roomStatuses={roomStatuses}
                                onCheckInOut={handleRoomCheckInOut}
                                getRoomBookingInfo={getRoomBookingInfo}
                            />
                        )}

                        {view === 'add' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-logo-green-100 p-6 fade-in">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Icons.Plus size={24} className="text-logo-green-700"/> New Booking/Sale</h2>
                                <form onSubmit={(e) => handleSubmit(e, formData.type)} className="space-y-5">
                                    
                                    {/* Conditional Branch Selector for Owner Admin */}
                                    {user.currentBranch === 'ALL' ? (
                                        <div className="relative">
                                            <Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" />
                                            <select  
                                                required  
                                                value={formData.targetBranch}  
                                                onChange={(e)=>setFormData({...formData, targetBranch:e.target.value})}  
                                                className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white appearance-none text-slate-600 font-bold border-logo-green-400"
                                            >
                                                <option value="" disabled>SELECT TARGET BRANCH*</option>
                                                {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                            </select>
                                            <Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/>
                                        </div>
                                    ) : (
                                        <div className="p-3 bg-logo-green-50 rounded-lg text-sm text-logo-green-800 font-medium flex items-center gap-2"><Icons.MapPin size={16}/> Adding to: {user.currentBranch}</div>
                                    )}

                                    {/* Date Picker for Future Booking */}
                                    <div className="relative">
                                        <label className="text-xs font-bold text-slate-500 ml-1 mb-1 block uppercase">Booking Date</label>
                                        <Icons.Calendar size={18} className="absolute left-3 top-9 text-slate-400" />
                                        <input  
                                            type="date"  
                                            required
                                            value={formData.bookingDate}
                                            onChange={e => setFormData({...formData, bookingDate: e.target.value})}
                                            className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white"
                                        />
                                    </div>

                                    {/* Location Toggle (In Spa / Home Service) */}
                                    <div className="grid grid-cols-2 gap-3 bg-slate-100 p-1.5 rounded-xl">
                                        <button  
                                            type="button"  
                                            onClick={() => toggleLocation('spa')}
                                            className={`py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all ${formData.location === 'spa' ? 'bg-white text-logo-green-700 shadow-sm' : 'text-slate-400'}`}
                                        >
                                            <Icons.Building2 size={16}/> In Spa
                                        </button>
                                        <button  
                                            type="button"  
                                            onClick={() => toggleLocation('home')}
                                            className={`py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all ${formData.location === 'home' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}
                                        >
                                            <Icons.Car size={16}/> Home Service
                                        </button>
                                    </div>

                                    {/* Spa Specifics (Room Selection - Multi) */}
                                    {formData.location === 'spa' && (
                                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 animate-fadeIn space-y-2">
                                            <label className="text-xs font-bold text-slate-500 mb-1 block flex items-center gap-1"><Icons.DoorOpen size={12}/> Assigned Room(s)</label>
                                            
                                            {/* Selected Room Tags */}
                                            <div className="flex flex-wrap gap-2 mb-2">
                                                {selectedRooms.map(rName => (
                                                    <span key={rName} className="bg-white text-logo-green-600 text-xs px-2 py-1 rounded-md border border-logo-green-200 flex items-center gap-1 font-bold shadow-sm">
                                                        {rName}
                                                        <button type="button" onClick={() => toggleRoomSelection(rName)} className="hover:text-red-500"><Icons.X size={12}/></button>
                                                    </span>
                                                ))}
                                            </div>

                                            <select  
                                                value="" // Must be empty to allow onChange to fire on selecting the same value
                                                onChange={e => {
                                                    if(e.target.value) toggleRoomSelection(e.target.value);
                                                }}
                                                className="w-full p-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-500 bg-white appearance-none text-sm"
                                            >
                                                <option value="">+ Add Room</option>
                                                {roomsList.map(r => {
                                                    const status = roomStatuses[r.name]?.status;
                                                    const isOccupied = status === 'occupied';
                                                    const isSelected = selectedRooms.includes(r.name);
                                                    
                                                    // Only show if not selected OR if selected (to allow unselection if needed)
                                                    if (!isSelected && isOccupied) return null;

                                                    return (
                                                        <option 
                                                            key={r.id} 
                                                            value={r.name} 
                                                            disabled={isOccupied && !isSelected}
                                                            className={isOccupied ? 'text-red-500' : 'text-slate-700'}
                                                        >
                                                            {r.name} ({isOccupied ? 'Unavailable' : 'Available'})
                                                        </option>
                                                    );
                                                })}
                                            </select>
                                            {roomsList.length === 0 && <p className="text-[10px] text-red-400 mt-1 italic">No rooms found. Add in Lists tab (Admin).</p>}
                                        </div>
                                    )}

                                    {/* Home Service Specifics (Transport & Driver) */}
                                    {formData.location === 'home' && (
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 animate-fadeIn space-y-4">
                                            <div>
                                                <label className="text-xs font-bold text-blue-700 mb-1 block">Transportation Charge (Total)</label>
                                                <div className="relative">
                                                    <span className="absolute left-3 top-3 text-blue-400 font-bold">P</span>
                                                    <input 
                                                        type="number"  
                                                        placeholder="0.00"  
                                                        value={formData.transportFee}
                                                        onChange={handleTransportChange}
                                                        className="w-full pl-8 pr-4 py-2 rounded-lg border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                                    />
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label className="text-xs font-bold text-blue-700 mb-1 block flex items-center gap-1"><Icons.SteeringWheel size={12}/> Assigned Drivers</label>
                                                
                                                {/* Selected Drivers Tags */}
                                                <div className="flex flex-wrap gap-2 mb-2">
                                                    {selectedDrivers.map(dName => (
                                                        <span key={dName} className="bg-white text-blue-600 text-xs px-2 py-1 rounded-md border border-blue-200 flex items-center gap-1 font-bold shadow-sm">
                                                            {dName}
                                                            <button type="button" onClick={() => toggleDriverSelection(dName)} className="hover:text-red-500"><Icons.X size={12}/></button>
                                                        </span>
                                                    ))}
                                                </div>

                                                <select  
                                                    value=""  
                                                    onChange={e => {
                                                        if(e.target.value) toggleDriverSelection(e.target.value);
                                                    }}
                                                    className="w-full p-2 rounded-lg border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white appearance-none text-sm"
                                                >
                                                    <option value="">+ Add Driver</option>
                                                    {driversList
                                                        .filter(d => !selectedDrivers.includes(d.name))
                                                        .map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                                                </select>
                                                {driversList.length === 0 && <p className="text-[10px] text-red-400 mt-1 italic">No drivers found. Add in Lists tab (Admin).</p>}
                                            </div>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-4">
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-2 ${formData.type==='booking'?'border-logo-green-700 bg-logo-green-50/50':'border-slate-100'}`}><input type="radio" name="type" value="booking" checked={formData.type==='booking'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.Calendar/><span className="text-sm font-bold">Appointment</span></label>
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-2 ${formData.type==='sale'?'border-teal-600 bg-teal-50/50':'border-slate-100'}`}><input type="radio" name="type" value="sale" checked={formData.type==='sale'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.DollarSign/><span className="text-sm font-bold">Direct Pay</span></label>
                                    </div>
                                    
                                    <div className="space-y-2">
                                        <input required placeholder="Client Name*" value={formData.clientName} onChange={e=>setFormData({...formData, clientName:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                        {/* Client Contact Input */}
                                        <input placeholder="Client Contact No." value={formData.clientContact} onChange={e=>setFormData({...formData, clientContact:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        
                                        {/* Therapist Dropdown Replacement - Multi Select */}
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase flex justify-between items-center">
                                                <span>Therapists & Services*</span>
                                                <span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-400">{selectedTherapists.length} Added</span>
                                            </label>
                                            
                                            {/* Selected Therapists List (Service/Duration/Price per Therapist) */}
                                            {selectedTherapists.length > 0 ? (
                                                <div className="space-y-3 mb-2">
                                                    {selectedTherapists.map(name => (
                                                        <div key={name} className="w-full bg-white border border-logo-green-200 shadow-sm rounded-xl p-3 flex flex-col gap-2 relative fade-in">
                                                            <div className="flex justify-between items-center border-b border-slate-50 pb-2">
                                                                <span className="font-bold text-logo-green-800 flex items-center gap-2 text-sm"><Icons.User size={16}/> {name}</span>
                                                                <button type="button" onClick={() => toggleTherapistSelection(name)} className="text-slate-300 hover:text-red-500 transition"><Icons.X size={18}/></button>
                                                            </div>
                                                            <div className="flex flex-col gap-2">
                                                                <select  
                                                                    required
                                                                    value={therapistRows[name]?.service || ''}  
                                                                    onChange={(e) => updateTherapistRow(name, 'service', e.target.value)}
                                                                    className="text-xs p-2 border border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-1 focus:ring-logo-green-500 outline-none w-full"
                                                                >
                                                                    <option value="" disabled>Select Service*</option>
                                                                    {Object.entries(groupedServices).map(([category, services]) => (
                                                                        <optgroup key={category} label={category}>
                                                                            {services.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                                                        </optgroup>
                                                                    ))}
                                                                </select>
                                                                <div className="grid grid-cols-2 gap-2">
                                                                    <select  
                                                                        required
                                                                        value={therapistRows[name]?.duration || ''}  
                                                                        onChange={(e) => updateTherapistRow(name, 'duration', e.target.value)}
                                                                        className="text-xs p-2 border border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-1 focus:ring-logo-green-500 outline-none"
                                                                    >
                                                                        <option value="" disabled>Duration*</option>
                                                                        {durationsList.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                                                                    </select>
                                                                    <div className="relative">
                                                                        <span className="absolute left-2.5 top-2 text-slate-400 text-xs">P</span>
                                                                        <input  
                                                                            type="number" 
                                                                            step="0.01"
                                                                            required
                                                                            value={therapistRows[name]?.amount || ''}  
                                                                            onChange={(e) => updateTherapistRow(name, 'amount', e.target.value)}
                                                                            className="w-full text-xs p-2 pl-6 border border-slate-200 rounded-lg bg-slate-50 font-bold text-slate-700 focus:bg-white focus:ring-1 focus:ring-logo-green-500 outline-none"
                                                                            placeholder="0.00"
                                                                        />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="p-4 border-2 border-dashed border-slate-200 rounded-xl text-center text-slate-400 text-xs italic bg-slate-50">
                                                    No therapists added yet.
                                                </div>
                                            )}

                                            {/* Add Therapist Dropdown */}
                                            <div className="relative">
                                                <select  
                                                    value=""  
                                                    onChange={e => {
                                                        if(e.target.value) toggleTherapistSelection(e.target.value);
                                                    }}  
                                                    className="w-full p-3 pl-10 border rounded-xl bg-slate-50 appearance-none hover:bg-slate-100 transition cursor-pointer text-logo-green-700 font-bold"
                                                >
                                                    <option value="">+ Add Therapist</option>
                                                    {therapistsList
                                                        .filter(t => !selectedTherapists.includes(t.name))
                                                        .map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                                </select>
                                                <Icons.Plus size={18} className="absolute left-3 top-3.5 text-logo-green-600 pointer-events-none"/>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Discount Selector */}
                                    <div className="relative mt-4">
                                        <label className="text-xs font-bold text-slate-500 ml-1 mb-1 block uppercase">Apply Discount (Optional)</label>
                                        <Icons.Tag size={18} className="absolute left-3 top-9 text-slate-400" />
                                        <select  
                                            value={selectedDiscountId}  
                                            onChange={e => setSelectedDiscountId(e.target.value)}
                                            className={`w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white appearance-none text-slate-600 ${selectedDiscountId ? 'border-orange-400 font-bold' : ''}`}
                                        >
                                            <option value="">No Discount Applied</option>
                                            {discountsList.map(d => (
                                                <option key={d.id} value={d.id}>
                                                    {d.name} ({d.type === 'Percentage' ? `${d.value}%` : formatCurrency(d.value)})
                                                </option>
                                            ))}
                                        </select>
                                        <Icons.ChevronDown size={16} className="absolute right-3 top-9 text-slate-400 pointer-events-none"/>
                                    </div>

                                    {/* Service Notes Textarea */}
                                    <textarea  
                                        placeholder="Service Notes (e.g., Hard pressure, No oil on back, Client prefers quiet)"  
                                        rows="2"
                                        value={formData.notes}  
                                        onChange={e=>setFormData({...formData, notes:e.target.value})}  
                                        className="w-full p-3 border rounded-xl bg-slate-50 resize-none text-sm"
                                    />

                                    <div className="grid grid-cols-2 gap-4 items-center">
                                        <input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 text-center font-bold text-slate-600"/>
                                        
                                        <div className="text-right">
                                            <p className="text-[10px] text-slate-400 uppercase font-bold">Total Estimate</p>
                                            <p className="text-2xl font-extrabold text-logo-green-700">
                                                {formatCurrency(totalEstimatedPrice)}
                                            </p>
                                            {selectedDiscountId && (
                                                <p className="text-xs text-orange-600 font-bold">(-{formatCurrency(getAppliedDiscountValue(selectedTherapists.reduce((acc, name) => acc + (parseFloat(therapistRows[name]?.amount) || 0), 0)))})</p>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Payment Method Selector */}
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-2 block uppercase">Payment Method</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {[
                                                { label: 'Cash', icon: <Icons.Banknote size={18}/> },  
                                                { label: 'GCash', icon: <Icons.Smartphone size={18}/> },  
                                                { label: 'Maya', icon: <Icons.Smartphone size={18}/> },  
                                                { label: 'BPI', icon: <Icons.Landmark size={18}/> },  
                                                { label: 'Eastwest Bank', icon: <Icons.Landmark size={18}/> },
                                                { label: 'Card', icon: <Icons.CreditCard size={18}/> }
                                            ].map(method => (
                                                <button
                                                    type="button"
                                                    key={method.label}
                                                    onClick={() => setFormData({ ...formData, paymentMethod: method.label })}
                                                    className={`p-3 rounded-xl border flex flex-col items-center justify-center gap-1 text-[10px] font-bold transition-all ${
                                                        formData.paymentMethod === method.label
                                                            ? 'bg-slate-800 text-white border-slate-800 shadow-md transform scale-[1.02]'
                                                            : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'
                                                    }`}
                                                >
                                                    {method.icon}
                                                    <span className="text-center leading-tight">{method.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <button className="w-full bg-logo-green-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2 hover:bg-logo-green-800 transition transform active:scale-95">Save Booking</button>
                                </form>
                            </div>
                        )}
                        
                        {/* Expense Tracking View */}
                        {view === 'expense' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-red-100 p-6 fade-in">
                                <h2 className="text-xl font-bold text-red-700 mb-6 flex items-center gap-2"><Icons.MinusCircle size={24}/> Log Expense</h2>
                                <form onSubmit={(e) => handleSubmit(e, 'expense')} className="space-y-5">
                                    
                                    {user.currentBranch === 'ALL' ? (
                                        <div className="relative">
                                            <Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" />
                                            <select  
                                                required  
                                                value={formData.targetBranch}  
                                                onChange={(e)=>setFormData({...formData, targetBranch:e.target.value})}  
                                                className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-red-700 bg-slate-50 focus:bg-white appearance-none text-slate-600 font-bold border-red-400"
                                            >
                                                <option value="" disabled>SELECT BRANCH AFFECTED*</option>
                                                {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                            </select>
                                            <Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/>
                                        </div>
                                    ) : (
                                        <div className="p-3 bg-red-50 rounded-lg text-sm text-red-800 font-medium flex items-center gap-2"><Icons.MapPin size={16}/> Logging for: {user.currentBranch}</div>
                                    )}

                                    <div className="flex gap-2">
                                        <select required value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})} className="flex-1 p-3 border rounded-xl bg-slate-50 appearance-none">
                                            <option value="" disabled>Select Category*</option>
                                            <option value="Supplies">Supplies (Oil, Linens, etc.)</option>
                                            <option value="Maintenance">Maintenance/Repair</option>
                                            <option value="Utilities">Utilities Payment (Partial)</option>
                                            <option value="Food/Beverage">Staff Food/Beverage</option>
                                            <option value="Other">Other Expense</option>
                                        </select>
                                        <input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-[120px] p-3 border rounded-xl bg-slate-50"/>
                                    </div>
                                    
                                    <input required  
                                        type="number" step="0.01"  
                                        min="0.01"
                                        placeholder="Amount Spent (P)*"  
                                        value={formData.amount}
                                        onChange={handleExpenseAmountChange}
                                        className="w-full p-3 border rounded-xl bg-slate-50 border-red-300 font-bold"
                                    />
                                    
                                    <textarea  
                                        required
                                        placeholder="Description / Reason (e.g. Bought 1 bottle of Isopropyl Alcohol)"  
                                        rows="3"
                                        value={formData.notes}  
                                        onChange={e=>setFormData({...formData, notes:e.target.value})}  
                                        className="w-full p-3 border rounded-xl bg-slate-50 resize-none"
                                    />
                                    <button className="w-full bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2 hover:bg-red-800">Submit Expense</button>
                                </form>
                            </div>
                        )}
                        
                        {view === 'profile' && (
                            <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6 fade-in">
                                <h3 className="font-bold text-slate-800 mb-4 flex gap-2"><Icons.UserCog className="text-logo-green-700"/> Profile</h3>
                                <div className="bg-slate-50 p-4 rounded-xl border mb-6"><p className="text-xs text-slate-400 uppercase font-bold">Account</p><p className="font-bold text-logo-green-800 text-lg">{user.name}</p></div>
                                <form onSubmit={handleUpdateProfile} className="space-y-4">
                                    <input required value={profileData.username} onChange={e=>setProfileData({...profileData, username:e.target.value})} className="w-full p-3 border rounded-lg" placeholder="New Username"/>
                                    <input  
                                        type="password"  
                                        inputMode="numeric"  
                                        maxLength={user.role === 'admin' ? 6 : 4}
                                        value={profileData.pin}  
                                        onChange={e=>setProfileData({...profileData, pin:e.target.value})}  
                                        className="w-full p-3 border rounded-lg font-mono"  
                                        placeholder={`New PIN (${user.role === 'admin' ? '6' : '4'} digits. Leave blank to keep old)`}
                                    />
                                    <button className="w-full bg-logo-green-700 text-white font-bold py-3 rounded-lg">Update Credentials</button>
                                </form>
                            </div>
                        )}
                        
                        {/* Data List Management View */}
                        {view === 'lists' && user.role === 'admin' && (  
                            <ListManagement  
                                therapists={therapistsList}  
                                services={servicesList}
                                durations={durationsList}
                                drivers={driversList}
                                rooms={roomsList} 
                                discounts={discountsList} // Pass discounts
                                onAdd={handleAddItem}  
                                onDelete={handleDeleteItem}
                                onEdit={handleEditItem}
                            />
                        )}

                        {view === 'team' && user.role === 'admin' && (  
                            <div className="space-y-6 fade-in">
                                <h2 className="text-lg font-bold text-logo-green-900 flex gap-2"><Icons.Users/> Manage Staff</h2>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    {users.filter(u => {
                                        // Owner Admin sees everyone
                                        if (user.username === 'admin') return true;

                                        // Admin/Staff sees themselves
                                        if (u.id === user.id) return true;

                                        // Admin sees other users in their branch
                                        if (u.username === 'admin') return false;

                                        return u.currentBranch === user.currentBranch;
                                    })
                                    .sort((a, b) => {
                                        // Sort by name
                                        return a.name.localeCompare(b.name);
                                    })
                                    .map(u=>(
                                        <div  
                                            key={u.id}  
                                            className="p-4 border-b flex justify-between items-center hover:bg-slate-50 transition"
                                        >
                                            <div>
                                                <h3 className="font-bold flex items-center">
                                                    {u.name}  
                                                    {u.username === 'admin' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-logo-green-100 text-logo-green-700 ml-2">OWNER/ADMIN</span>}  
                                                    {u.username !== 'admin' && u.role === 'admin' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 ml-2">ADMIN</span>}  
                                                    {u.role === 'staff' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 ml-2">STAFF</span>}  
                                                </h3>
                                                <p className="text-xs text-slate-400">
                                                    @{u.username} â€¢ {u.currentBranch || 'Unknown Branch'}
                                                </p>
                                            </div>
                                            <div className="flex gap-2 items-center">
                                                {/* Toggle Role Button (Owner Admin only) */}
                                                {user.username === 'admin' && u.username !== 'admin' && (
                                                    <button
                                                        onClick={(e)=>{e.stopPropagation(); handleToggleRole(u);}}
                                                        className={`p-1 rounded transition ${u.role === 'admin' ? 'text-orange-400 hover:text-orange-600 hover:bg-orange-50' : 'text-blue-400 hover:text-blue-600 hover:bg-blue-50'}`}
                                                        title={u.role === 'admin' ? "Demote to Staff" : "Promote to Admin"}
                                                    >
                                                        {u.role === 'admin' ? <Icons.User size={16}/> : <Icons.ShieldCheck size={16}/>}
                                                    </button>
                                                )}

                                                {/* Explicit View/Reset PIN button (Owner Admin only) */}
                                                {user.username === 'admin' && (
                                                    <button
                                                        onClick={(e)=>{e.stopPropagation(); setEditUserModal({ isOpen: true, user: u, newPin: '' });}}
                                                        className="text-slate-300 hover:text-logo-green-700 p-1"
                                                        title="View Username / Reset PIN"
                                                    >
                                                        <Icons.Lock size={16}/>
                                                    </button>
                                                )}

                                                {/* Delete button visible to Admin */}
                                                {user.role === 'admin' && (  
                                                    <button  
                                                        onClick={(e)=>{e.stopPropagation(); handleDeleteUser(u.id)}}  
                                                        className="p-1.5 text-slate-300 hover:text-red-500"
                                                        title="Delete User"
                                                    >
                                                        <Icons.Trash2 size={16}/>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border p-6">
                                    <h3 className="font-bold mb-4">Add Staff</h3>
                                    <form onSubmit={(e) => {
                                        e.preventDefault();
                                        handleAddUser(e);
                                    }} className="space-y-4">
                                        <input required placeholder="Name" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})} className="w-full p-2 border rounded"/>
                                        <input required placeholder="Username" value={newUser.username} onChange={e=>setNewUser({...newUser, username:e.target.value})} className="w-full p-2 border rounded"/>
                                        <div className="flex gap-2">
                                            <input  
                                                required  
                                                maxLength={newUser.role === 'admin' ? 6 : 4} // Dynamic length
                                                placeholder={`PIN (${newUser.role === 'admin' ? 6 : 4} digits)`}  
                                                type="password"  
                                                inputMode="numeric"  
                                                value={newUser.pin}  
                                                onChange={e=>setNewUser({...newUser, pin:e.target.value})}  
                                                className="w-full p-2 border rounded"
                                            />
                                            {/* Role options */}
                                            <select value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value, pin:''})} className="w-full p-2 border rounded">
                                                <option value="staff">Staff (4-digit PIN)</option>  
                                                <option value="admin">Admin (6-digit PIN)</option>  
                                            </select>
                                        </div>
                                        <button className="w-full bg-logo-green-700 text-white py-2 rounded font-bold">Add User</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {view === 'history' && (  
                            <div className="space-y-4 fade-in">
                                <h2 className="text-lg font-bold text-logo-green-900 flex gap-2"><Icons.History/> History</h2>
                                
                                {/* Date Range Filters */}
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100 grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Start Date</label>
                                        <input type="date" value={historyStartDate} onChange={(e) => setHistoryStartDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">End Date</label>
                                        <input type="date" value={historyEndDate} onChange={(e) => setHistoryEndDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/>
                                    </div>
                                </div>

                                {filteredHistory.length === 0 ? (
                                    <div className="text-center py-12 border border-dashed rounded-xl text-slate-400 text-sm">No historical reports found for this period.</div>
                                ) : (
                                    filteredHistory.map(h => (
                                        <div key={h.id} className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                            <div onClick={()=>setExpandedHistoryId(expandedHistoryId===h.id?null:h.id)} className="p-4 flex justify-between items-center cursor-pointer">
                                                <div><h3 className="font-bold text-slate-800">{h.date_formatted || h.date}</h3><p className="text-xs text-slate-400">{h.branch || 'Unknown'} â€¢ Closed by {h.closedBy}</p></div>
                                                <div className="flex items-center gap-4">
                                                    <button onClick={(e)=>{e.stopPropagation();downloadCSV(h)}} title="Download CSV"><Icons.Download size={20} className="text-slate-400 hover:text-logo-green-700"/></button>
                                                    {user.role === 'admin' && <button onClick={(e)=>{e.stopPropagation();handleDeleteHistory(h.id, h.date)}} title="Delete Report"><Icons.Trash2 size={20} className="text-slate-400 hover:text-red-500"/></button>}
                                                    <span className={`font-bold ${h.stats.netCash < 0 ? 'text-red-600' : 'text-logo-green-700'}`}>{formatCurrency(h.stats.netCash)}</span>
                                                    {expandedHistoryId===h.id?<Icons.ChevronUp size={20} className="text-slate-400"/>:<Icons.ChevronDown size={20} className="text-slate-400"/>}
                                                </div>
                                            </div>
                                            {expandedHistoryId===h.id && (
                                                <div className="bg-slate-50 p-4 border-t text-sm">
                                                    {/* Display Therapist Commission Breakdown */}
                                                    {h.therapist_stats && Object.keys(h.therapist_stats).length > 0 && (
                                                        <div className="mb-4">
                                                            <h4 className="text-xs font-bold text-logo-green-700 uppercase mb-2 flex items-center gap-1"><Icons.Trophy size={12}/> Daily Commission Breakdown:</h4>
                                                            {Object.keys(h.therapist_stats).map(branch => (
                                                                <div key={branch} className="mb-2 last:mb-0">
                                                                    {Object.keys(h.therapist_stats).length > 1 && (
                                                                        <h5 className="text-[10px] font-bold text-slate-500 uppercase px-1">{branch}</h5>
                                                                    )}
                                                                    <div className="space-y-1">
                                                                        {h.therapist_stats[branch].map(s => (
                                                                            <div key={s.name} className="flex justify-between text-xs border-b border-slate-200 last:border-0 pb-1">
                                                                                <span className="font-semibold text-slate-700">{s.name} ({s.rate}%)</span>
                                                                                <span className="font-bold text-teal-600">{formatCurrency(s.commission)}</span>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            <hr className="mt-2"/>
                                                        </div>
                                                    )}
                                                    {/* END Display Therapist Commission Breakdown */}

                                                    <h4 className="text-xs font-bold text-slate-700 uppercase mb-2 flex items-center gap-1"><Icons.ClipboardList size={12}/> Transaction Log:</h4>
                                                    {h.transactions.map((t,i)=><div key={i} className="flex flex-col py-2 border-b last:border-0"><div className="flex justify-between"><span>{t.time} - {t.type==='expense'? t.category : t.clientName} ({t.type === 'expense' ? 'Expense' : t.service})</span><span className={`font-bold ${t.type==='expense'?'text-red-600':'text-logo-green-700'}`}>{formatCurrency(t.amount)}</span></div>{t.notes && t.notes.trim() && <span className="text-xs text-slate-500 italic mt-1">Desc: {t.notes}</span>}</div>)}
                                                </div>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* Global Modal */}
                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                        
                        {/* Loading Overlay */}
                        {isGlobalLoading && <LoadingOverlay message="Processing..." />}
                    </main>
                    {view === 'dashboard' && <button onClick={()=>setView('add')} className="fixed bottom-6 right-6 bg-logo-green-700 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform"><Icons.Plus size={28}/></button>}

                    {/* Admin Reset User Modal */}
                    <AdminResetUserModal  
                        editUserModal={editUserModal}  
                        setEditUserModal={setEditUserModal}  
                        handleResetPin={handleResetPin}
                        userRole={user?.role}
                    />
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
